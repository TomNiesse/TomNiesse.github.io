<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Posts on Welcome!</title>
        <link>https://tomniesse.github.io/posts/</link>
        <description>Recent content in Posts on Welcome!</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <copyright>&lt;a href=&#34;https://creativecommons.org/licenses/by-nc/4.0/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CC BY-NC 4.0&lt;/a&gt;</copyright>
        <lastBuildDate>Sun, 09 Apr 2023 13:28:55 +0200</lastBuildDate>
        <atom:link href="https://tomniesse.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
        
        <item>
            <title>Printing ABS using an Ender 3 (v1), without an enclosure</title>
            <link>https://tomniesse.github.io/posts/ender3-abs-printing/</link>
            <pubDate>Sun, 09 Apr 2023 13:28:55 +0200</pubDate>
            
            <guid>https://tomniesse.github.io/posts/ender3-abs-printing/</guid>
            <description>Introduction When looking for a guide on how to print ABS using a cheap printer, people usually say &amp;ldquo;it&amp;rsquo;s impossible&amp;rdquo;, &amp;ldquo;it requires a printer enclosure&amp;rdquo; or &amp;ldquo;you just have to remove the fans&amp;rdquo;.
I disagree with all those statements. In this youtube video, someone put duct tape on their Ender 3 and was able to print ABS just fine.
And if someone else can do it, it must be possible.</description>
            <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1>
<p>When looking for a guide on how to print ABS using a cheap printer, people usually say &ldquo;it&rsquo;s impossible&rdquo;, &ldquo;it requires a printer enclosure&rdquo; or &ldquo;you just have to remove the fans&rdquo;.<br>
I disagree with all those statements. In <a href="https://www.youtube.com/watch?v=wjSpVN19x7A">this youtube video</a>, someone put duct tape on their Ender 3 and was able to print ABS just fine.<br>
And if someone else can do it, it must be possible.</p>
<p>This page documents the adventure of ABS printing using a 3D printer without an enclosure.</p>
<h1 id="airflow-and-duct-tape">Airflow and duct tape</h1>
<p>The main issue with ABS printing on an Ender 3 is that the cooling fan (not the print cooling fan) blows air down, onto the print.<br>
If the air is directed away from the print, ABS will print just fine.</p>
<p>After applying duct tape to my own printer, I got similar results: it produced a good print!<br>
However, it also melted all the duct tape. This made a big mess.</p>
<p><a href="images/ducttape_solution.jpg"><img src="images/ducttape_solution.jpg" alt="The duct tape solution"></a></p>
<h1 id="adding-the-new-airflow-cover-to-the-printer">Adding the new airflow cover to the printer</h1>
<p>Because duct tape was not a long term solution, I created a new part for the Ender 3 v1. The stl file is <a href="https://www.thingiverse.com/thing:5631450">hosted on thingiverse</a>.</p>
<p>The designed cover was first printed in PLA. This went as well as one would expect: it melted pretty quickly during printing.<br>
It held up just long enough to print another cover (made out of ABS).</p>
<p><a href="images/pla_vs_abs_cover.jpg"><img src="images/pla_vs_abs_cover.jpg" alt="The PLA and ABS airflow covers"></a></p>
<p>The ABS cover (on the right) has been attached to my printer ever since, and is doing just fine! It doesn&rsquo;t deform like the PLA cover did.</p>
<h1 id="differences-between-pla-and-abs">Differences between PLA and ABS</h1>
<p>ABS is a little different when it comes to printing. Here&rsquo;s my experience with it so far:</p>
<h4 id="pros">Pros</h4>
<ul>
<li>As long as the airflow cover is on, the ambient temperature can be as low as 17°C. Prints will still come out just fine</li>
<li>As long as the print bed is hot (110°C, the maximum bed temperature for the Ender 3 v1), the ABS sticks to the bed very well.<br>
Just like with small PLA prints though, a brim may be required.</li>
</ul>
<h4 id="cons">Cons</h4>
<ul>
<li>When printing very fast, ABS doesn&rsquo;t always hold it&rsquo;s shape. Due to it cooling down, walls can &ldquo;move inwards&rdquo;. This then creates a &ldquo;)(&quot;-shape instead of a &ldquo;||&quot;-shape.<br>
The only solution I have found so far is to print more slowly.</li>
<li>Overhangs are not always well-shaped. A benchy comes out just fine, but smaller prints don&rsquo;t always look good.<br>
I have yet to test if this also happens when printing slowly.<br>
Normally, the cooling fan would fix everything, but the air cover blocks almost all air.</li>
<li>When printing large ABS print, warping and delamination may occur.</li>
</ul>
<h1 id="printing-a-benchy-using-abs">Printing a benchy using ABS</h1>
<p>To test how well the airflow cover would work, I printed a benchy. It came out looking very well, but the roof was a little weak due to slight delamination.<br>
This probably had to do with cooling, since the rest of the boat was just fine. The below image shows the Ender 3 printing a benchy out of ABS.<br>
No enclosure was used and the ambient temperature was around 17°C that day.</p>
<p><a href="images/benchy.jpg"><img src="images/benchy.jpg" alt="Printing a benchy without a brim"></a></p>
<h1 id="summary">Summary</h1>
<p>Printing ABS is possible using an Ender 3 v1. It&rsquo;s not perfect, but still very doable. The delamination is still an issue, but I think it can be fixed.</p>
]]></content>
        </item>
        
        <item>
            <title>Creating an embedded OS that runs a DOS game</title>
            <link>https://tomniesse.github.io/posts/buildroot-dune-dynasty/</link>
            <pubDate>Tue, 21 Dec 2021 13:28:55 +0200</pubDate>
            
            <guid>https://tomniesse.github.io/posts/buildroot-dune-dynasty/</guid>
            <description>Introduction This page explains how the game &amp;ldquo;Dune Dynasty II&amp;rdquo; can be ran on an embedded linux OS. The OS is created using buildroot.
All required configurations and compile-commands are documented on this page.
The below image shows the game (and embedded OS) running.

Previous work This post is based on another post in which a basic embedded OS is created. However, the toolchain used uClibc as C library, which will not work here.</description>
            <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1>
<p>This page explains how the game &ldquo;Dune Dynasty II&rdquo; can be ran on an embedded linux OS. The OS is created using <a href="https://buildroot.org">buildroot</a>.<br>
All required configurations and compile-commands are documented on this page.</p>
<p>The below image shows the game (and embedded OS) running.</p>
<p><a href="images/game.jpg"><img src="images/game.jpg" alt="Buildroot OS running Dune Dynasty II"></a></p>
<h1 id="previous-work">Previous work</h1>
<p>This post is based on <a href="/posts/buildroot">another post</a> in which a basic embedded OS is created. However, the toolchain used uClibc as C library, which will not work here. This is why a new toolchain and Buildroot OS will be created. It is assumed that the previous post was followed and that all the tools and source code are already downloaded.</p>
<p>The previous post showed how to make a basic OS (using crosstool-NG, U-boot and Buildroot), which did very little of value. It just started a shell and that was it.<br>
Not very interesting.</p>
<p>In this post, the goals are as follows:</p>
<ul>
<li>Make a buildroot OS containing Allegro5 and Dune Dynasty</li>
<li>Compile the kernel without using Buildroot</li>
<li>Make the OS start as fast as possible</li>
</ul>
<h1 id="creating-a-new-toolchain">Creating a new toolchain</h1>
<p>For this OS, a new toolchain using glibc will be used. This is because uClibc creates lots of segfaults (probably while resolving libraries).</p>
<h2 id="creating-a-new-toolchain-configuration">Creating a new toolchain configuration</h2>
<p>First, a new toolchain configuration is created inside the crosstool-NG folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng distclean
./ct-ng aarch64-rpi4-linux-gnu
</code></pre></div><h2 id="making-a-few-changes-to-the-toolchain-configuration">Making a few changes to the toolchain configuration</h2>
<p>Then, the toolchain options are changed using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng menuconfig
</code></pre></div><p>The following options were changed:</p>
<ul>
<li>Under <code>C compiler</code>, the option <code>Version of gcc</code> is set to the second to latest option (<code>10.3.0</code> at time of writing)</li>
<li>Under <code>Operating System</code>, the option <code>Version of linux</code> is set to <code>5.10.79</code> (this is the version of linux that will be compiled later in this post)</li>
<li>Under <code>Debug facilities</code>, the option <code>gdb</code> is disabled.</li>
</ul>
<h2 id="building-the-new-toolchain">Building the new toolchain</h2>
<p><em>If <code>~/x-tools/</code> already contains a toolchain with the same name; move, rename or delete that toolchain. If it is not dealt with, the wrong linux headers might still be present and the target OS will fail to run. crosstool-NG will not build a shiny new toolchain automatically.</em></p>
<p>To then build the new toolchain, execute the build command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng build -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
</code></pre></div><h1 id="creating-a-new-buildroot-os">Creating a new Buildroot OS</h1>
<p>The previous post describes how to make a Buildroot OS using uClibc. Because this does not apply here anymore, a completely new Buildroot OS will be created.</p>
<h2 id="creating-a-new-configuration">Creating a new configuration</h2>
<p>Within Buildroot, using <code>make menuconfig</code>, the following options are changed to create a new OS:</p>
<ul>
<li>Under <code>Build options</code>, the option <code>Enable compiler cache</code> is enabled</li>
<li>Under <code>Build options</code>, the option <code>RELR0 protection</code> is set to <code>Partial</code></li>
<li>Under <code>Build options</code>, the option <code>Stack Smashing Protection</code> is set to <code>None</code></li>
<li>Under <code>Bootloaders</code>, all the options are disabled (the bootloader will be compiled manually)</li>
<li>Under <code>Kernel</code>, the option <code>Linux Kernel</code> is disabled (the kernel will be compiled manually)</li>
<li>Under <code>Filesystem images</code>, the option <code>ext2/3/4 root filesystem</code> is disabled</li>
<li>Under <code>Filesystem images</code>, the option <code>tar the root filesystem</code> is enabled, along with the <code>Compression method</code> set to <code>gzip</code></li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain type</code> is set to <code>External toolchain</code> (this post uses a toolchain built by crosstool-NG)</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain</code> is set to <code>Custom toolchain</code></li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain origin</code> is set to <code>Pre-installed toolchain</code></li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain path</code> is set to <code>/home/&lt;YOUR_USERNAME_GOES_HERE&gt;/x-tools/aarch64-rpi4-linux-gnu</code> (the path has to be absolute and may not contain <code>~/</code> or <code>/home/$USER/</code>!).</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain prefix</code> is set to <code>aarch64-rpi4-linux-gnu</code></li>
<li>Under <code>Toolchain</code>, the option <code>External toolchain C library</code> is set to <code>glibc/eglibc</code></li>
<li>Under <code>Toolchain</code>, the option <code>External toolchain gcc version</code> is set to <code>10.x</code> (matching the version from the toolchain)</li>
<li>Under <code>Toolchain</code>, the option <code>External toolchain kernel headers series</code> is set to <code>5.10.x</code> (matching the version from the toolchain)</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has locale support?</code> is enabled</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has threads support?</code> is enabled, along with the two extra options for threads support</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has SSP support?</code> is enabled</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has RPC support</code> is <strong>disabled</strong></li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has C++ support?</code> is enabled</li>
<li>Under <code>System configuration</code>, the option <code>System hostname</code> is set to <code>gaming</code></li>
<li>Under <code>System configuration</code>, the option <code>System banner</code> is set to <code>Welcome to gaming!</code></li>
<li>Under <code>System configuration</code>, the option <code>Root password</code> is set to <code>root</code> (the root login will be bypassed later, so this value does not matter too much)</li>
<li>Under <code>System configuration</code>, the option <code>/dev management</code> is set to <code>Dynamic using devtmpfs + mdev</code> (to load drivers automatically when the target device boots)</li>
<li>Under <code>System configuration</code>, the option <code>Enable Native Language Support (NLS)</code> is enabled</li>
</ul>
<p>The following additional options are changed to install all required dependencies for <code>X.org</code> and <code>Allegro5</code>:</p>
<ul>
<li>Under <code>Target packages</code> -&gt; <code>Hardware handling</code> -&gt; <code>Firmware</code>, the option <code>rpi 4 (default)</code> is <strong>disabled</strong> (all the extra firmware is not needed)</li>
<li>Under <code>Target packages</code> -&gt; <code>Hardware handling</code> -&gt; <code>Firmware</code>, the option <code>rpi 4 (cut-down)</code> is enabled</li>
<li>Under <code>Target packages</code> -&gt; <code>Graphic libraries and applications (graphic/text)</code>, the option <code>ratpoison</code> is enabled (Dune Dynasty refuses to run without a WM and ratpoison places windows in the middle of the screen by default)</li>
<li>Under <code>Target packages</code> -&gt; <code>Graphic libraries and applications (graphic/text)</code>, the option <code>X.org X Window System</code> is enabled, along with the following options:
<ul>
<li><code>X11R7 Servers</code> -&gt; <code>xorg-server</code></li>
<li><code>X11R7 Servers</code> -&gt; <code>Xvfb server</code></li>
<li><code>X11R7 Applications</code> -&gt; <code>xinit</code></li>
<li><code>X11R7 Applications</code> -&gt; <code>xinput</code></li>
<li><code>X11R7 Applications</code> -&gt; <code>xrandr</code></li>
<li><code>X11R7 Drivers</code> -&gt; <code>xf86-input-keyboard</code></li>
<li><code>X11R7 Drivers</code> -&gt; <code>xf86-input-mouse</code></li>
<li><code>X11R7 Drivers</code> -&gt; <code>xf86-video-fbdev</code></li>
<li><code>X11R7 Drivers</code> -&gt; <code>xf86-video-fbturbo</code></li>
</ul>
</li>
<li>Under <code>Target packages</code> -&gt; <code>Graphic libraries and applications (graphic/text)</code>, the option <code>mesa3d</code> is enabled, along with the following options:
<ul>
<li><code>Gallium v3d driver</code></li>
<li><code>Gallium vc4 driver</code></li>
<li><code>DRI nouveau driver</code> (Enable DRI support by enabling at least one driver, or Dune Dynasty will give a black screen with the following error log: <code>bo.1: permission denied</code>)</li>
<li><code>OSMesa (Gallium) library</code></li>
<li><code>OpenGL GLX</code></li>
<li><code>OpenGL EGL</code></li>
<li><code>OpenGL ES</code></li>
</ul>
</li>
<li>Under <code>Target packages</code> -&gt; <code>Graphic libraries and applications (graphic/text)</code>, the option <code>sdl2</code> is enabled, along with the following extra options:
<ul>
<li><code>X11 video driver</code></li>
<li><code>KMS/DRM video driver</code></li>
<li><code>OpenGL (GLX)</code></li>
<li><code>OpenGL ES</code></li>
<li><code>sdl2_gfx</code></li>
<li><code>sdl2_ttf</code></li>
<li><code>sdl2_image</code></li>
<li><code>sdl2_mixer</code></li>
</ul>
</li>
<li>Under <code>Target packages</code> -&gt; <code>Graphic libraries and applications (graphic/text)</code>, the option <code>xterm</code> is enabled (for debugging)</li>
<li>Under <code>Target packages</code> -&gt; <code>Audio and video applications</code>, the option <code>fluidsynth</code> is enabled, along with the following extra options:
<ul>
<li>alsa</li>
<li>jack2</li>
<li>sdl2</li>
</ul>
</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Graphics</code>, the option <code>libglew</code> is enabled</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Graphics</code>, the option <code>libglfw</code> is enabled</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Graphics</code>, the option <code>libglu</code> is enabled</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Graphics</code>, the option <code>libgtk3</code> is enabled, along with the option <code>X11 GDK backend</code> (the rest is <strong>disabled</strong>)</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Filesystem</code>, the option <code>physfs</code> is enabled</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Audio/Sound</code>, the option <code>opusfile</code> is enabled</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Audio/Sound</code>, the option <code>libmad</code> is enabled</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Audio/Sound</code>, the option <code>alsa-lib</code> is enabled, as well as all the extra options it provides</li>
<li>Under <code>Target packages</code> -&gt; <code>Libraries</code> -&gt; <code>Multimedia</code>, the option <code>libtheora</code> is enabled</li>
</ul>
<p>The target OS should now have all required dependencies enabled.</p>
<h2 id="automatic-post-build-system-changes">Automatic post-build system changes</h2>
<p>There are a few changes made to the system after it&rsquo;s built. These changes are as follows:</p>
<ul>
<li>Make sure <code>mdev</code> loads device firmware</li>
<li>Bypass the login prompt</li>
<li>Make sure X.org starts correctly when <code>xinit</code> is executed inside the target OS</li>
<li>Make sure Dune Dynasty is started when the WM starts</li>
<li>Disable automatic network setup</li>
</ul>
<p>To make sure these changes are always present in the target OS, the following will be appended to <code>/path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/post-build.sh</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Make sure device firmware is being loaded during boot</span>
cp package/busybox/S10mdev <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S10mdev
chmod <span style="color:#ae81ff">755</span> <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S10mdev
chmod +x <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S10mdev
cp package/busybox/mdev.conf <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/mdev.conf

<span style="color:#75715e"># Skip login by changing /etc/inittab</span>
sed -i s<span style="color:#e6db74">&#39;|console::respawn:/sbin/getty -L  console 0 vt100 # GENERIC_SERIAL|# login bypass|g&#39;</span> <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/inittab
sed -i <span style="color:#e6db74">&#39;s|tty1::respawn:/sbin/getty -L  tty1 0 vt100 # HDMI console|::respawn:-/bin/sh -c &#34;xinit&#34;|g&#39;</span> <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/inittab

<span style="color:#75715e"># Make sure X.org works</span>
sed -i <span style="color:#e6db74">&#39;s| Driver|#Driver|g&#39;</span> <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/X11/xorg.conf

<span style="color:#75715e"># Configure ratpoison WM</span>
echo <span style="color:#e6db74">&#34;startup_message off&#34;</span> &gt; <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/.ratpoisonrc
echo <span style="color:#e6db74">&#34;exec /usr/local/bin/dunedynasty&#34;</span> &gt;&gt; <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/.ratpoisonrc

<span style="color:#75715e"># Configure xinit</span>
echo <span style="color:#e6db74">&#39;export LD_LIBRARY_PATH=&#34;/lib:/usr/lib:/usr/local/lib&#34;&#39;</span> &gt; <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/.xinitrc
echo <span style="color:#e6db74">&#34;ratpoison&#34;</span> &gt;&gt; <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/.xinitrc

<span style="color:#75715e"># Delete X.org and networking init files</span>
rm <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S40xorg
rm <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S40network
</code></pre></div><h2 id="automatically-build-and-install-allegro5-and-dune-dynasty-to-target-os">Automatically build and install Allegro5 and Dune Dynasty to target OS</h2>
<p>The <code>post-build.sh</code> file will also be used to automatically install Allegro5 and Dune Dynasty to the target OS.</p>
<p>There are two directories within Buildroot that are required when building and installing Allegro5 and Dune Dynasty:</p>
<ul>
<li><code>target</code>: buildroot-&lt;VERSION_GOES_HERE&gt;/output/target (<code>post-build.sh</code> refers to this as <code>${TARGET_DIR}</code>)</li>
<li><code>sysroot</code>: buildroot-&lt;VERSION_GOES_HERE&gt;/output/host/aarch64-buildroot-linux-gnu/sysroot (or, <code>${TARGET_DIR}/../host/aarch64-buildroot-linux-gnu/sysroot</code>)</li>
</ul>
<p>Compiling can only be done against the <code>sysroot</code> directory, while the target OS is stored in the <code>target</code> directory. For this reason, Allegro5 must be installed to both directories to compile and run Dune Dynasty correctly.</p>
<h3 id="creating-a-toolchain-for-both-allegro5-and-dune-dynasty">Creating a toolchain for both Allegro5 and Dune Dynasty</h3>
<p>A file called <code>Toolchain-raspberrypi4_64.cmake</code> is created inside the <code>/path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi</code>, with the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#############</span>
<span style="color:#75715e"># Set target OS</span>
<span style="color:#75715e">#############</span>

set<span style="color:#f92672">(</span>CMAKE_SYSTEM_NAME Linux<span style="color:#f92672">)</span>

<span style="color:#75715e">######################################################</span>
<span style="color:#75715e"># Force CMake to use the toolchain built by crosstool-NG</span>
<span style="color:#75715e"># (both 64 bit and 32 bit cross-compiling toolchains can</span>
<span style="color:#75715e"># be used here)</span>
<span style="color:#75715e">######################################################</span>

set<span style="color:#f92672">(</span>CMAKE_TOOLCHAIN_FILE /home/&lt;YOUR_USERNAME_GOES_HERE&gt;/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_C_COMPILER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-gcc<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_CXX_COMPILER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-g++<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_LINKER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-ld<span style="color:#f92672">)</span>

set<span style="color:#f92672">(</span>MAKE_C_LINK_EXECUTABLE <span style="color:#e6db74">${</span>CMAKE_LINKER<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>MAKE_CXX_LINK_EXECUTABLE <span style="color:#e6db74">${</span>CMAKE_LINKER<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>

<span style="color:#75715e">#########################################################</span>
<span style="color:#75715e"># Tell CMake to do all compiling against the target sysroot</span>
<span style="color:#75715e">#########################################################</span>

set<span style="color:#f92672">(</span>CMAKE_SYSROOT /path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/output/host/aarch64-buildroot-linux-gnu/sysroot<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSROOT_COMPILE <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSROOT_LINK <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSTEM_PREFIX_PATH <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_INSTALL_PREFIX <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>

<span style="color:#75715e">#######################################################</span>
<span style="color:#75715e"># Make sure CMake does not link against host OS libraries</span>
<span style="color:#75715e">#######################################################</span>

set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FINE_ROOT_PATH_MODE_PACKAGE ONLY<span style="color:#f92672">)</span>

<span style="color:#75715e">###############################################</span>
<span style="color:#75715e"># Make sure Allegro5 is found (using pkg-config).</span>
<span style="color:#75715e"># Only Dune Dynasty needs this. When building</span>
<span style="color:#75715e"># Allegro5, this part is ignored by CMake.</span>
<span style="color:#75715e">###############################################</span>

set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_DIR<span style="color:#f92672">}</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_LIBDIR<span style="color:#f92672">}</span> <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/usr/lib/pkgconfig:<span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/usr/share/pkgconfig:<span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/usr/local/lib/pkgconfig/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_PATH<span style="color:#f92672">}</span> <span style="color:#e6db74">${</span>PKG_CONFIG_LIBDIR<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_SYSROOT_DIR<span style="color:#f92672">}</span> <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
</code></pre></div><p>This toolchain file is used by Allegro5 and Dune Dynasty to cross-compile and link to the target Buildroot OS.</p>
<h3 id="automate-the-installation-of-allegro5-and-dune-dynasty">Automate the installation of Allegro5 and Dune Dynasty</h3>
<p>To make sure Allegro5 and Dune Dynasty are added to the target OS after Buildroot is done creating it, the following is appended to <code>/path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/post-build.sh</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Add Allegro5 and Dune Dynasty to the target rootfs</span>

<span style="color:#75715e"># Create a temporary download directory</span>
rm -rf tmp
mkdir tmp
cd tmp

<span style="color:#75715e"># Install Allegro5 to target OS and development sysroot</span>
wget https://github.com/liballeg/allegro5/releases/download/5.2.7.0/allegro-5.2.7.0.tar.gz
tar -xvf allegro-5.2.7.0.tar.gz
rm -rf allegro-5.2.7.0.tar.gz
cp ../board/raspberrypi/Toolchain-raspberrypi4_64.cmake allegro-5.2.7.0/cmake/
cd allegro-5.2.7.0/
mkdir build
cd build
rm -rf CMakeFiles CMakeCache.txt addons cmake_install.cmake demos docs examples include lib Makefile tests
cmake -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span>cmake/Toolchain-raspberrypi4_64.cmake -DSHARED<span style="color:#f92672">=</span>on -DCMAKE_LINKER_FLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-static-libgcc -static-libstdc++&#34;</span> ..
make -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
DESTDIR<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/../host/aarch64-buildroot-linux-gnu/sysroot make install <span style="color:#75715e"># install to target sysroot to compile dune dynasty against</span>
DESTDIR<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span> make install <span style="color:#75715e"># install to target system</span>

cd ../../

<span style="color:#75715e"># Install Dune Dynasty to target OS</span>
rm -rf dunedynasty-1.5.7/
wget https://versaweb.dl.sourceforge.net/project/dunedynasty/dunedynasty-1.5/dunedynasty-1.5.7.tar.gz
tar -xvf dunedynasty-1.5.7.tar.gz
rm -rf dunedynasty-1.5.7.tar.gz
cp ../board/raspberrypi/Toolchain-raspberrypi4_64.cmake dunedynasty-1.5.7/cmake/
cd dunedynasty-1.5.7/
mkdir build
cd build
cmake -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span>cmake/Toolchain-raspberrypi4_64.cmake ..
make -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
DESTDIR<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span> make install <span style="color:#75715e"># install to target system</span>

cd ../../../
</code></pre></div><h2 id="creating-a-new-buildroot-os-1">Creating a new Buildroot OS</h2>
<p>To then create a new OS, the make command is executed within Buildroot:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make clean
make
</code></pre></div><p>After Buildroot is done, a file called <code>rootfs.tar.gz</code> is created inside the <code>/path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/output/images</code> directory. This is the entire OS, minus the kernel.</p>
<h1 id="compiling-the-linux-kernel">Compiling the linux kernel</h1>
<p>While Buildroot is doing it&rsquo;s thing, a linux kernel can be compiled. There exists a <a href="https://github.com/raspberrypi/linux">github repository</a> containing a complete kernel source for the Raspberry Pi. This source will be used to create a kernel.</p>
<h2 id="downloading-the-source">Downloading the source</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/raspberrypi/linux
git checkout rpi-5.10.y <span style="color:#75715e"># version 5.10.y matches the one from the toolchain</span>
git checkout d261fd9f97da8b6b3ed1fa613cc3fd6abb41f0be <span style="color:#75715e"># known working commit for the paranoid (optional)</span>
cd linux
</code></pre></div><h2 id="configuring-the-source">Configuring the source</h2>
<p>To see all available default configurations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls arch/arm64/configs/
</code></pre></div><p>To pick the one for the Raspberry Pi 4:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>~/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu- make bcm2711_defconfig
</code></pre></div><h2 id="compiling">Compiling</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>~/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu- make clean
ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>~/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu- make -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>~/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu- make modules -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
</code></pre></div><p>After the compiling process is done, there should be a file called <code>Image</code> inside the <code>/path/to/linux/arch/arm64/boot</code> directory.</p>
<h1 id="creating-a-system-image">Creating a system image</h1>
<p>Buildroot is done, Linux is compiled. Everything can now be put inside of a system image. This process will be automated using a file called <code>build_image.sh</code>.</p>
<h2 id="creating-raspberry-pi-4-boot-configuration-configtxt">Creating Raspberry Pi 4 boot configuration (config.txt)</h2>
<p>Before <code>build_image.sh</code> can do it&rsquo;s thing, a file called <code>config.txt</code> will be created in the root directory of the project. The file will have the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#75715e"># Enable 64 bit mode</span>
<span style="color:#a6e22e">arm_64bit</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>

<span style="color:#75715e"># Make the raspberry Pi 4 start the linux binary called &#34;Image&#34;</span>
<span style="color:#a6e22e">kernel</span><span style="color:#f92672">=</span><span style="color:#e6db74">Image</span>

<span style="color:#75715e"># Disable bluetooth</span>
<span style="color:#a6e22e">dtoverlay</span><span style="color:#f92672">=</span><span style="color:#e6db74">disable-bt</span>

<span style="color:#75715e"># Run cut-down files</span>
<span style="color:#a6e22e">start_file</span><span style="color:#f92672">=</span><span style="color:#e6db74">start4cd.elf</span>
<span style="color:#a6e22e">fixup_file</span><span style="color:#f92672">=</span><span style="color:#e6db74">fixup4cd.dat</span>

<span style="color:#75715e"># Go fast</span>
<span style="color:#a6e22e">arm_boost</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">initial_turbo</span><span style="color:#f92672">=</span><span style="color:#e6db74">20</span>
<span style="color:#a6e22e">boot_delay</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
<span style="color:#a6e22e">boot_delay_ms</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
<span style="color:#a6e22e">force_eeprom_read</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
<span style="color:#a6e22e">start_cd</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>
<span style="color:#a6e22e">start_x</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>
<span style="color:#a6e22e">enable_uart</span><span style="color:#f92672">=</span><span style="color:#e6db74">0</span>

<span style="color:#75715e"># Disable rainbow splash screen</span>
<span style="color:#a6e22e">disable_splash</span><span style="color:#f92672">=</span><span style="color:#e6db74">1</span>

<span style="color:#75715e"># Enable DRM VC4 V3D driver overlay</span>
<span style="color:#a6e22e">dtoverlay</span><span style="color:#f92672">=</span><span style="color:#e6db74">vc4-fkms-v3d-pi4</span>
<span style="color:#a6e22e">max_framebuffers</span><span style="color:#f92672">=</span><span style="color:#e6db74">2</span>
<span style="color:#a6e22e">gpu_mem</span><span style="color:#f92672">=</span><span style="color:#e6db74">128</span>

<span style="color:#75715e"># Enable audio</span>
<span style="color:#a6e22e">dtparam</span><span style="color:#f92672">=</span><span style="color:#e6db74">audio=on</span>
</code></pre></div><h2 id="creating-raspberry-pi-4-boot-configuration-cmdlinetxt">Creating Raspberry Pi 4 boot configuration (cmdline.txt)</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">rng_core.default_quality<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span> dwc_otg.lpm_enable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> console<span style="color:#f92672">=</span>tty1 root<span style="color:#f92672">=</span>/dev/mmcblk0p2 rootfstype<span style="color:#f92672">=</span>ext4 rootwait quiet
</code></pre></div><h2 id="creating-the-build-script">Creating the build script</h2>
<p>The file <code>build_image.sh</code> is created inside the root directory of the project, and has the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#########################################</span>
<span style="color:#75715e"># Create a system image called &#34;system.img&#34;</span>
<span style="color:#75715e">#########################################</span>

rm -rf system.img
sudo dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/zero of<span style="color:#f92672">=</span>system.img bs<span style="color:#f92672">=</span>1MiB count<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span> status<span style="color:#f92672">=</span>progress
sudo sync

echo <span style="color:#e6db74">&#34;mklabel msdos&#34;</span> | sudo parted system.img
echo <span style="color:#e6db74">&#34;mkpart primary fat16 2048s 30MiB&#34;</span> | sudo parted system.img
echo <span style="color:#e6db74">&#34;mkpart primary ext4 30MiB 100%&#34;</span> | sudo parted system.img
echo <span style="color:#e6db74">&#34;set 1 boot on&#34;</span> | sudo parted system.img
<span style="color:#75715e"># echo &#34;print&#34; | sudo parted system.img</span>
<span style="color:#75715e"># sleep 10</span>
sudo chmod <span style="color:#ae81ff">777</span> system.img

<span style="color:#75715e">###########################################</span>
<span style="color:#75715e"># Mount the system image, as if it&#39;s a device</span>
<span style="color:#75715e">###########################################</span>

SYSTEM_IMAGE<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>sudo losetup -Pf system.img --show<span style="color:#e6db74">`</span>

<span style="color:#75715e">##########################</span>
<span style="color:#75715e"># Partition the system image</span>
<span style="color:#75715e">##########################</span>

sudo mkfs.vfat -n BOOT <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p1&#34;</span><span style="color:#e6db74">`</span>   <span style="color:#75715e"># Create a fat16 partition for boot files</span>
sudo mkfs.ext4 -L ROOTFS <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p2&#34;</span><span style="color:#e6db74">`</span> <span style="color:#75715e"># Create an ext4 partition for rootfs files</span>

<span style="color:#75715e">########################</span>
<span style="color:#75715e"># Mount the new partitions</span>
<span style="color:#75715e">########################</span>

sudo rm -rf ./target_mnt
mkdir ./target_mnt
sudo mount <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p2&#34;</span><span style="color:#e6db74">`</span> ./target_mnt
sudo mkdir ./target_mnt/boot
sudo mount <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p1&#34;</span><span style="color:#e6db74">`</span> ./target_mnt/boot

<span style="color:#75715e">###############</span>
<span style="color:#75715e"># Copy boot files</span>
<span style="color:#75715e">###############</span>

<span style="color:#75715e"># Raspberry Pi 4 boot configuration</span>
sudo cp ./config.txt ./target_mnt/boot/
sudo cp ./cmdline.txt ./target_mnt/boot/

<span style="color:#75715e"># firmware</span>
sudo cp ./buildroot-2021.11/output/images/rpi-firmware/bcm2711-rpi-4-b.dtb ./target_mnt/boot/
sudo cp ./buildroot-2021.11/output/images/rpi-firmware/start4cd.elf ./target_mnt/boot/
sudo cp ./buildroot-2021.11/output/images/rpi-firmware/fixup4cd.dat ./target_mnt/boot/
sudo cp ./buildroot-2021.11/output/images/rpi-firmware/overlays ./target_mnt/boot -r

<span style="color:#75715e"># kernel</span>
sudo cp ./linux/arch/arm64/boot/Image ./target_mnt/boot/

sleep <span style="color:#ae81ff">3</span>

<span style="color:#75715e">#################</span>
<span style="color:#75715e"># Copy rootfs files</span>
<span style="color:#75715e">#################</span>

<span style="color:#75715e"># buildroot&#39;s rootfs</span>
cd target_mnt/
sudo tar -xvf ../buildroot-2021.11/output/images/rootfs.tar.gz .
cd ..

sleep <span style="color:#ae81ff">3</span>

<span style="color:#75715e"># kernel</span>
cd linux
sudo INSTALL_MOD_PATH<span style="color:#f92672">=</span>../target_mnt/ ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>/home/tom/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu- make modules_install
cd ..

sleep <span style="color:#ae81ff">3</span>

<span style="color:#75715e"># game files</span>
sudo cp ./data ./target_mnt -r

<span style="color:#75715e">########################</span>
<span style="color:#75715e"># Unmount the system image</span>
<span style="color:#75715e">########################</span>

sudo sync
sudo umount ./target_mnt/boot -l
sudo umount ./target_mnt -l
sudo losetup -D
sudo rm -rf ./target_mnt
</code></pre></div><p>The system should now be ready to run Dune Dynasty. Flash the system.img file to any Raspberry Pi 4&rsquo;s SD card and see the OS in action!</p>
<h1 id="debugging">Debugging</h1>
<p>If the system does not boot into ratpoison automatically, the game can be started manually, using the following commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># start X.org (will start one xterm window for now)</span>
xinit
<span style="color:#75715e"># start twm window manager</span>
exec twm &amp;
<span style="color:#75715e"># load some kernel modules related to hardware acceleration (still in testing phase)</span>
modprobe v3d
modprobe vc4
<span style="color:#75715e"># make sure the Dune Dynasty binary can find the Allegro5 library files</span>
export LD_LIBRARY_PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/lib:/usr/lib:/usr/local/lib&#34;</span>
<span style="color:#75715e"># start Dune Dynasty</span>
/usr/local/bin/dunedynasty
</code></pre></div><h1 id="extras">Extra&rsquo;s</h1>
<h2 id="building-allegro5-manually-optional">Building Allegro5 manually (optional)</h2>
<p>To compile Dune Dynasty, the <a href="https://github.com/liballeg/allegro5">Allegro5 game programming library</a> is needed.</p>
<p>Buildroot must be done building before Allegro5 is built; Allegro5 cannot compile against an incomplete OS.</p>
<h3 id="downloading-the-source-files">Downloading the source files</h3>
<p>To download and extract the Allegro5 library source file, the following commands are executed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/liballeg/allegro5/releases/download/5.2.7.0/allegro-5.2.7.0.tar.gz
tar -xvf allegro-5.2.7.0.tar.gz
rm -rf allegro-5.2.7.0.tar.gz
cd allegro-5.2.7.0/
</code></pre></div><h3 id="configuring-cmake">Configuring CMake</h3>
<p>In the folder <code>allegro-5.2.7.0/cmake</code> are a bunch of files related to CMake. Within the list of files there is a file called <a href="https://github.com/liballeg/allegro5/blob/master/cmake/Toolchain-raspberrypi.cmake">Toolchain-raspberrypi.cmake</a>. This file contains configuration that tells CMake how to build the library for the first Raspberry Pi. The first Raspberry Pi is 32 bit and the toolchain does <em>not</em> have multilib support enabled. Therefor, a new toolchain must be created.</p>
<p>A custom file called <code>Toolchain-raspberrypi4_64.cmake</code> will be created and placed inside the <code>allegro-5.2.7.0/cmake</code> directory. The file will contain the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#############</span>
<span style="color:#75715e"># Set target OS</span>
<span style="color:#75715e">#############</span>

set<span style="color:#f92672">(</span>CMAKE_SYSTEM_NAME Linux<span style="color:#f92672">)</span>

<span style="color:#75715e">######################################################</span>
<span style="color:#75715e"># Force CMake to use the toolchain built by crosstool-NG</span>
<span style="color:#75715e"># (both 64 bit and 32 bit cross-compiling toolchains can</span>
<span style="color:#75715e"># be used here)</span>
<span style="color:#75715e">######################################################</span>

set<span style="color:#f92672">(</span>CMAKE_TOOLCHAIN_FILE /home/&lt;YOUR_USERNAME_GOES_HERE&gt;/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_C_COMPILER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-gcc<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_CXX_COMPILER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-g++<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_LINKER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-ld<span style="color:#f92672">)</span>

set<span style="color:#f92672">(</span>MAKE_C_LINK_EXECUTABLE <span style="color:#e6db74">${</span>CMAKE_LINKER<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>MAKE_CXX_LINK_EXECUTABLE <span style="color:#e6db74">${</span>CMAKE_LINKER<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>

<span style="color:#75715e">#########################################################</span>
<span style="color:#75715e"># Tell CMake to do all compiling against the target sysroot</span>
<span style="color:#75715e">#########################################################</span>

set<span style="color:#f92672">(</span>CMAKE_SYSROOT /path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/output/host/aarch64-rpi4-linux-gnu/sysroot<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSROOT_COMPILE <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSROOT_LINK <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSTEM_PREFIX_PATH <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_INSTALL_PREFIX <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>

<span style="color:#75715e">#######################################################</span>
<span style="color:#75715e"># Make sure CMake does not link against host OS libraries</span>
<span style="color:#75715e">#######################################################</span>

set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FINE_ROOT_PATH_MODE_PACKAGE ONLY<span style="color:#f92672">)</span>
</code></pre></div><p>When the following commands are then executed, the Allegro library will be built:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># create a build directory and go into it, to separate source code from binaries</span>
mkdir build/
cd build/

<span style="color:#75715e"># delete old build files (in case the previous build failed)</span>
rm -rf CMakeFiles CMakeCache.txt addons cmake_install.cmake demos docs examples include lib Makefile tests

<span style="color:#75715e"># configure CMake</span>
cmake -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span>cmake/Toolchain-raspberrypi4_64.cmake -DSHARED<span style="color:#f92672">=</span>on -DCMAKE_LINKER_FLAGS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-static-libgcc -static-libstdc++&#34;</span> ..

<span style="color:#75715e"># build Allegro5</span>
make -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
</code></pre></div><h3 id="manually-installing-allegro5-to-the-target-buildroot-os">Manually installing Allegro5 to the target Buildroot OS</h3>
<p>After Allegro5 is done compiling, it can be installed to the target OS using the environment variable <code>DESTDIR</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># dune dynasty will compile against this sysroot, it cannot compile against target</span>
DESTDIR<span style="color:#f92672">=</span>path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/output/host/&lt;COMPILING_TOOLCHAIN_GOES_HERE&gt;/sysroot make install
<span style="color:#75715e"># install to target OS as well</span>
DESTDIR<span style="color:#f92672">=</span>path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/output/target/ make install
</code></pre></div><h2 id="manually-compiling-dune-dynasty-against-the-target-buildroot-os">Manually compiling Dune Dynasty against the target Buildroot OS</h2>
<p>It it assumed that Allegro5 was installed to the target Buildroot OS. If it&rsquo;s not, this has to be done before continuing.</p>
<p>First, download and extract the game:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://versaweb.dl.sourceforge.net/project/dunedynasty/dunedynasty-1.5/dunedynasty-1.5.7.tar.gz
tar -xvf dunedynasty-1.5.7.tar.gz
rm -rf dunedynasty-1.5.7.tar.gz
</code></pre></div><p>Then, create a toolchain file in the <code>dunedynasty-1.5.7/cmake</code> directory, called <code>Toolchain-raspberrypi4_64.cmake</code>. The toolchain is almost the same as the one from Allegro5, but with some extra configuration at the bottom:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#############</span>
<span style="color:#75715e"># Set target OS</span>
<span style="color:#75715e">#############</span>
set<span style="color:#f92672">(</span>CMAKE_SYSTEM_NAME Linux<span style="color:#f92672">)</span>

<span style="color:#75715e">######################################################</span>
<span style="color:#75715e"># Force CMake to use the toolchain built by crosstool-NG</span>
<span style="color:#75715e"># (both 64 bit and 32 bit cross-compiling toolchains can</span>
<span style="color:#75715e"># be used here)</span>
<span style="color:#75715e">######################################################</span>

set<span style="color:#f92672">(</span>CMAKE_TOOLCHAIN_FILE /home/&lt;YOUR_USERNAME_GOES_HERE&gt;/x-tools/aarch64-rpi4-linux-gnu/bin/aarch64-rpi4-linux-gnu<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_C_COMPILER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-gcc<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_CXX_COMPILER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-g++<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_LINKER <span style="color:#e6db74">${</span>CMAKE_TOOLCHAIN_FILE<span style="color:#e6db74">}</span>-ld<span style="color:#f92672">)</span>

set<span style="color:#f92672">(</span>MAKE_C_LINK_EXECUTABLE <span style="color:#e6db74">${</span>CMAKE_LINKER<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>MAKE_CXX_LINK_EXECUTABLE <span style="color:#e6db74">${</span>CMAKE_LINKER<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>

<span style="color:#75715e">#########################################################</span>
<span style="color:#75715e"># Tell CMake to do all compiling against the target sysroot</span>
<span style="color:#75715e">#########################################################</span>

set<span style="color:#f92672">(</span>CMAKE_SYSROOT /path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/output/host/&lt;COMPILING_TOOLCHAIN_GOES_HERE&gt;/sysroot<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSROOT_COMPILE <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSROOT_LINK <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_SYSTEM_PREFIX_PATH <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_INSTALL_PREFIX <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>

<span style="color:#75715e">#######################################################</span>
<span style="color:#75715e"># Make sure CMake does not link against host OS libraries</span>
<span style="color:#75715e">#######################################################</span>

set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>CMAKE_FINE_ROOT_PATH_MODE_PACKAGE ONLY<span style="color:#f92672">)</span>

<span style="color:#75715e">##############################################</span>
<span style="color:#75715e"># Make sure Allegro5 is found (using pkg-config)</span>
<span style="color:#75715e">##############################################</span>

set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_DIR<span style="color:#f92672">}</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_LIBDIR<span style="color:#f92672">}</span> <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/usr/lib/pkgconfig:<span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/usr/share/pkgconfig:<span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span>/usr/local/lib/pkgconfig/<span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_PATH<span style="color:#f92672">}</span> <span style="color:#e6db74">${</span>PKG_CONFIG_LIBDIR<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
set<span style="color:#f92672">(</span>ENV<span style="color:#f92672">{</span>PKG_CONFIG_SYSROOT_DIR<span style="color:#f92672">}</span> <span style="color:#e6db74">${</span>CMAKE_SYSROOT<span style="color:#e6db74">}</span><span style="color:#f92672">)</span>
</code></pre></div><p>To then compile the game, create a directory called <code>build</code>, go into it and compile everything:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># go inside a build directory to separate binaries from source code</span>
mkdir build/
cd build/

<span style="color:#75715e"># configure CMake</span>
cmake -DCMAKE_TOOLCHAIN_FILE<span style="color:#f92672">=</span>../cmake/Toolchain-raspberrypi4_64.cmake ..

<span style="color:#75715e"># build the game</span>
make -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
</code></pre></div><h3 id="installing-the-game-to-the-target-sysroot">Installing the game to the target sysroot</h3>
<p>Installing the binaries to the target sysroot is exactly the same process as installing Allegro5:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo DESTDIR<span style="color:#f92672">=</span>path/to/buildroot-&lt;VERSION_GOES_HERE&gt;/output/target/ make install <span style="color:#75715e"># install to target OS</span>
</code></pre></div>]]></content>
        </item>
        
        <item>
            <title>Creating an access point using buildroot</title>
            <link>https://tomniesse.github.io/posts/buildroot-ap/</link>
            <pubDate>Mon, 20 Dec 2021 13:28:55 +0200</pubDate>
            
            <guid>https://tomniesse.github.io/posts/buildroot-ap/</guid>
            <description>Introduction This page describes how a minimal router OS can be created using buildroot.
All configurations and build commands are documented on this page.
The resulting OS will boot, connect to the first LAN-network it can find and then start an access point.
Previous work This post is based on another post in which a basic embedded OS is created.
Editing the minimal Buildroot OS Configuring the access point part of the target system With the options above all set, the Raspberry Pi 4 should boot the target system without any issues.</description>
            <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1>
<p>This page describes how a minimal router OS can be created using <a href="https://buildroot.org">buildroot</a>.<br>
All configurations and build commands are documented on this page.</p>
<p>The resulting OS will boot, connect to the first LAN-network it can find and then start an access point.</p>
<h1 id="previous-work">Previous work</h1>
<p>This post is based on <a href="/posts/buildroot">another post</a> in which a basic embedded OS is created.</p>
<h1 id="editing-the-minimal-buildroot-os">Editing the minimal Buildroot OS</h1>
<h2 id="configuring-the-access-point-part-of-the-target-system">Configuring the access point part of the target system</h2>
<p>With the options above all set, the Raspberry Pi 4 should boot the target system without any issues. But, because the goal is to create a router out of the Raspberry Pi 4, some extra configuration is needed.</p>
<p>In the <code>menuconfig</code> of buildroot, make the following extra changes:</p>
<ul>
<li>Under <code>Build options</code>, the option <code>RELRO Protection</code> is set to partial</li>
<li>Under <code>Target packages</code> -&gt; <code>BusyBox</code>, the option <code>Show packages that are also provided by busybox</code></li>
<li>Under <code>Target packages</code> -&gt; <code>Networking applications</code>, the option <code>iptables</code> is enabled, along with the following options:
<ul>
<li><code>bpfc and nfsynproxy</code></li>
<li><code>nftables compat</code></li>
</ul>
</li>
<li>Under <code>Target packages</code> -&gt; <code>Networking applications</code>, the option <code>dhcp (ISC)</code> is enabled, along with the following options:
<ul>
<li><code>dhcp server</code>, along with:
<ul>
<li><code>Enable delayed ACK feature</code></li>
</ul>
</li>
</ul>
</li>
<li>Under <code>Target packages</code> -&gt; <code>Networking applications</code> -&gt; <code>wpa_supplicant</code>, the following options are enabled:
<ul>
<li><code>Enable nl80211 support</code></li>
<li><code>Enable AP mode</code></li>
<li><code>Enable EAP</code></li>
<li><code>Enable WPA3 support</code></li>
<li><code>Install wpa_passphrase binary</code></li>
<li><code>Enable support for the DBus control interface</code> (optional, if control via DBus is desired)</li>
<li><code>Introspection support</code> (optional, also has to do with control via DBus)</li>
</ul>
</li>
<li>Under <code>Target packages</code> -&gt; <code>Hardware handling</code> -&gt; <code>Firmware</code>, the option <code>rpi-wifi-firmware</code> is enabled.</li>
</ul>
<p>Using the command <code>make linux-menuconfig</code>, the following additional changes are made to the kernel configuration (still within Buildroot):</p>
<ul>
<li>Under <code>CPU Power Management</code> -&gt; <code>CPU Frequency scaling</code>, the option <code>Default CPUFreq governor</code> is set to <code>ondemand</code></li>
</ul>
<h2 id="adding-external-network-configuration-files-to-the-target-system">Adding external (network) configuration files to the target system</h2>
<p>Some configuration files are needed by the target system in order to make the access point a reality. Normally, configuration files would be created on the target system. In this case, this is not desireable. Fortunately, Buildroot had a file called <code>post-build.sh</code>, located in <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/</code>. This file will be used to automatically copy network configurations to the target system after it&rsquo;s been built.</p>
<h3 id="wpa_supplicantconf">wpa_supplicant.conf</h3>
<p>The tool <code>wpa_supplicant</code> is often used to connect to networks, but it can also be configured to act as an access point. In order to do this, it needs a configuration file called <code>wpa_supplicant.conf</code>.</p>
<p>To create a wireless access point on the target system, create a file called <code>wpa_supplicant.conf</code> and place it in <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/</code>. The file has the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">network<span style="color:#f92672">={</span>
    ssid<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;buildrootAP&#34;</span>  <span style="color:#75715e"># network name</span>
    psk<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;welcome01&#34;</span>     <span style="color:#75715e"># network password</span>
    mode<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>              <span style="color:#75715e"># act as an access point</span>
    proto<span style="color:#f92672">=</span>RSN
    key_mgmt<span style="color:#f92672">=</span>WPA-PSK
    pairwise<span style="color:#f92672">=</span>CCMP
    group<span style="color:#f92672">=</span>CCMP          <span style="color:#75715e"># allow only AES, not TKIP</span>
    <span style="color:#75715e">#frequency=5200     # uncomment to run access point on 5GHz</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>This configuration will create a WPA2 network with the name <code>buildrootAP</code> and password <code>welcome01</code>.</p>
<p>Frequency options are as follows:</p>
<ul>
<li>For a 2.4GHz access point: <code>2412</code>, <code>2417</code>, <code>2422</code>, <code>2427</code>, <code>2432</code>, <code>2437</code>, <code>2442</code>, <code>2447</code>, <code>2452</code>, <code>2457</code>, <code>2462</code>, <code>2467</code> or <code>2472</code></li>
<li>For a 5GHz access point: <code>5170</code>, <code>5180</code>, <code>5190</code>, <code>5200</code>, <code>5210</code>, <code>5220</code>, <code>5230</code>, <code>5240</code>, <code>5260</code>, <code>5280</code>, <code>5300</code>, <code>5320</code>, <code>5500</code>, <code>5520</code>, <code>5540</code>, <code>5560</code>, <code>5580</code>, <code>5600</code>, <code>5620</code>, <code>5640</code>, <code>5660</code>, <code>5680</code> or <code>5700</code></li>
</ul>
<p>On 5GHz, if the frequency is set too high, the signal will probably not travel through walls very well. A higher frequency does result in a faster internet speed. Not all frequencies may be supported by the wireless interface of the Raspberry Pi 4. If the network SSID does not appear after the Raspberry Pi 4 has started, change the frequency to another value.</p>
<h3 id="interfaces">interfaces</h3>
<p>Another common file found in Linux-based operating systems is a file called <code>interfaces</code>. This file often contains configurations regarding IP addressing of certain interfaces.</p>
<p>To create interface configuration for the target system, create a file called <code>interfaces</code> and place it in <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/</code>. The file is to contain the following configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">auto lo
iface lo inet loopback
auto eth0
iface eth0 inet dhcp
    udhcpc_opts -t <span style="color:#ae81ff">99</span> <span style="color:#75715e"># try 99 times before giving up</span>
    pre-up /etc/network/nfs_check
    wait-delay <span style="color:#ae81ff">15</span>
auto wlan0
iface wlan0 inet static
    address 192.168.200.1
    netmask 255.255.255.0
    network 192.168.200.0
    gateway 192.168.200.1
    pre-up wpa_supplicant -B -Dnl80211 -iwlan0 -c/etc/wpa_supplicant.conf
    post-down killall -q wpa_supplicant
    wait-delay <span style="color:#ae81ff">15</span>
iface default inet dhcp
</code></pre></div><h3 id="dhcpdconf">dhcpd.conf</h3>
<p>Almost every modern router has a DHCP server built in. So, the target system should also have one.</p>
<p>To configure the DHCP server on the target system, create a file called <code>dhcpd.conf</code> and place it in <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/</code>. The file is to have the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ddns-update-style none;
default-lease-time 600;
max-lease-time 7200;
authoritative;

subnet 192.168.200.0 netmask 255.255.255.0 <span style="color:#f92672">{</span>
  range 192.168.200.10 192.168.200.50;
  option broadcast-address 192.168.200.255;
  option routers 192.168.200.1;
  default-lease-time 600;
  max-lease-time 7200;
  option domain-name <span style="color:#e6db74">&#34;local&#34;</span>;
  option domain-name-servers 9.9.9.9, 1.1.1.1;
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="sysctlconf">sysctl.conf</h3>
<p>To allow packages to flow from one linux network interface to another, a file called <code>sysctl.conf</code> has to be created and placed in <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/</code>. The file is to have the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">net.ipv4.ip_forward <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</code></pre></div><h3 id="s02procps">S02procps</h3>
<p>To activate the above configuration file (<code>sysctl.conf</code>) when the target OS boots, a startup/service file called <code>S02procps</code> is created and placed in <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/</code>. The file will have the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#! /bin/sh
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;start&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    sysctl -p
<span style="color:#66d9ef">fi</span>
</code></pre></div><h3 id="s99firewall">S99firewall</h3>
<p>To configure firewall settings when the target OS boots, a service will be created. The file will be called <code>s99firewall</code> and placed in <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/</code>. The file will have the following contents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e">#! /bin/sh
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;start&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
    iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
    iptables -P FORWARD DROP
    iptables -A FORWARD -i eth0 -o wlan0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
    iptables -A FORWARD -i wlan0 -o eth0 -j ACCEPT
    iptables -P INPUT DROP
    iptables -A INPUT -i eth0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
    iptables -A INPUT -i wlan0 -j ACCEPT
<span style="color:#66d9ef">fi</span>
</code></pre></div><h2 id="copying-all-files-to-the-target-system">Copying all files to the target system</h2>
<p>To automatically copy all configuration files and services into the target system after it has been built, the following lines will be appended to <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/post-build.sh</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># copy configuration files</span>
cp board/raspberrypi/interfaces <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/network/interfaces
cp board/raspberrypi/wpa_supplicant.conf <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/wpa_supplicant.conf
cp board/raspberrypi/dhcpd.conf <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/dhcp/dhcpd.conf
cp board/raspberrypi/sysctl.conf <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/sysctl.conf

<span style="color:#75715e"># copy init scripts</span>
cp board/raspberrypi/S02procps <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S02procps
cp board/raspberrypi/S99firewall <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S99firewall

<span style="color:#75715e"># set permissions on the new init scripts</span>
chmod <span style="color:#ae81ff">755</span> <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S02procps
chmod <span style="color:#ae81ff">755</span> <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S99firewall

<span style="color:#75715e"># make the init scripts executable</span>
chmod +x <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S02procps
chmod +x <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S99firewall
</code></pre></div><h2 id="rebuilding-the-os">Rebuilding the OS</h2>
<p>After all configurations are done, rebuild the system as explained in the previous post.</p>
<h1 id="testing">Testing</h1>
<p>After the <code>system.img</code> file is flashed to an SD card, the SD card can be plugged into any Raspberry Pi 4.<br>
If a monitor is connected to the <code>HDMI0</code> port of the Raspberry Pi 4, the following logs can be seen:</p>
<p><a href="images/started.jpg"><img src="images/started.jpg" alt="Startup logs"></a></p>
<p>The Raspberry Pi successfully connected to a lan network and then started it&rsquo;s wireless access point. The network SSID should now be visible to client devices and connections can now be made.</p>
<p>The OS will fail to start the access point if it cannot connect to another LAN network via DHCP. If <code>udhcpc</code> fails after trying 99 times, the OS will not start a wireless network.</p>
<h1 id="sources">Sources</h1>
<ul>
<li><a href="https://bootlin.com/doc/training/buildroot/buildroot-slides.pdf">https://bootlin.com/doc/training/buildroot/buildroot-slides.pdf</a></li>
<li><a href="https://blog.crysys.hu/2018/06/enabling-wifi-and-converting-the-raspberry-pi-into-a-wifi-ap/">https://blog.crysys.hu/2018/06/enabling-wifi-and-converting-the-raspberry-pi-into-a-wifi-ap/</a></li>
<li><a href="https://unix.stackexchange.com/questions/439559/udhcpc-no-lease-failing-when-booting-on-embedded-linux-created-by-buildroot">https://unix.stackexchange.com/questions/439559/udhcpc-no-lease-failing-when-booting-on-embedded-linux-created-by-buildroot</a></li>
<li><a href="https://raspberrypi.stackexchange.com/questions/107858/raspberry-pi-4-b-5ghz-wifi-access-point-problem">https://raspberrypi.stackexchange.com/questions/107858/raspberry-pi-4-b-5ghz-wifi-access-point-problem</a></li>
<li><a href="http://lists.busybox.net/pipermail/buildroot/2019-June/252256.html">http://lists.busybox.net/pipermail/buildroot/2019-June/252256.html</a></li>
</ul>
]]></content>
        </item>
        
        <item>
            <title>Introduction to docker(-compose)</title>
            <link>https://tomniesse.github.io/posts/docker/</link>
            <pubDate>Sun, 05 Dec 2021 13:28:55 +0200</pubDate>
            
            <guid>https://tomniesse.github.io/posts/docker/</guid>
            <description>What is Docker? Docker is software that allows other programs and OS&amp;rsquo;es to run inside a container. There are other virtualization programs that can do the same (VMWare, VirtualBox, QEMU, etc.), but Docker allows building a container using a script. This script is called a Dockerfile. In addition to this, the package docker-compose allows running multiple dockerfiles at once. This way, multiple containers can run simultaneously and work together to get a certain task done.</description>
            <content type="html"><![CDATA[<h1 id="what-is-docker">What is Docker?</h1>
<p>Docker is software that allows other programs and OS&rsquo;es to run inside a container. There are other virtualization programs that can do the same (VMWare, VirtualBox, QEMU, etc.), but Docker allows building a container using a script. This script is called a <code>Dockerfile</code>. In addition to this, the package <code>docker-compose</code> allows running multiple dockerfiles at once. This way, multiple containers can run simultaneously and work together to get a certain task done. So, Docker takes much of the pain away when configuring a system, since all system configurations are stored inside the Dockerfiles. This post is going to explain the basics of making a Dockerfile and how docker-compose can manage multiple containers.</p>
<h1 id="creating-a-dockerfile">Creating a Dockerfile</h1>
<p>A Dockerfile is a configuration script for any given container. The Dockerfile contains all the commands needed to configure an entire container (virtual machine). This chapter explains how a Dockerfile is made. All commands one would normally insert into a system are now stored in a Dockerfile.</p>
<h2 id="the-syntax">The syntax</h2>
<p>Dockerfiles have the following syntax (where everything including and between the <code>&lt;</code> and <code>&gt;</code> is to be replaced):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#75715e"># this is a comment</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> &lt;existing container&gt;      # use someone else&#39;s already existing container to get started more quickly</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> &lt;command&gt;                  <span style="color:#75715e"># run a command inside the container (configure phase)</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># when the container starts, run the following command, where the two dashes (--) allow arguments from the host</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;&lt;/path/to/binary&gt;&#34;</span>, <span style="color:#960050;background-color:#1e0010">&lt;optional</span> <span style="color:#960050;background-color:#1e0010">argument</span> <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>, <span style="color:#960050;background-color:#1e0010">--</span>, <span style="color:#960050;background-color:#1e0010">&lt;optional</span> <span style="color:#960050;background-color:#1e0010">argument</span> <span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">&gt;</span>, <span style="color:#960050;background-color:#1e0010">...</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># when the container starts, run the following command (in case no arguments were given, this is the default)</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#e6db74">&#34;&lt;/path/to/binary&gt;&#34;</span>, <span style="color:#960050;background-color:#1e0010">&lt;optional</span> <span style="color:#960050;background-color:#1e0010">argument</span> <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">&gt;</span>, <span style="color:#960050;background-color:#1e0010">&lt;optional</span> <span style="color:#960050;background-color:#1e0010">argument</span> <span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">&gt;</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h2 id="a-real-world-example">A real world example</h2>
<p>In real life, a Dockerfile contains many more calls to <code>RUN</code> before the container is configured. In the example below, a gitea server is created within a Dockerfile:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#75715e"># use alpine linux</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> alpine:latest</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># install gitea</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk update<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apk add gitea<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># run gitea</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> /usr/bin/gitea<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># expose port 3000 to the host</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 3000</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>Before this Dockerfile is used to create a container, another file called <code>docker-compose.yml</code> is created to manage all containers.</p>
<h1 id="creating-a-docker-compose-configuration">Creating a docker-compose configuration</h1>
<h2 id="the-syntax-1">The syntax</h2>
<p>A configuration for docker-compose is to be called <code>docker-compose.yml</code> and it has the following syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#75715e"># a container which is built using a dockerfile</span>
  <span style="color:#f92672">a_service</span>:
    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">&lt;directory where the Dockerfile is located&gt;</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">&lt;container name goes here&gt;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#34;&lt;path/to/host/dir&gt;:&lt;path/to/guest/dir&gt;&#34;</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;&lt;host port&gt;:&lt;guest port&gt;&#34;</span>
  <span style="color:#75715e"># create another service; uses a pre-built image from Docker Hub</span>
  <span style="color:#f92672">another_service</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">&lt;image name from Docker Hub goes here&gt;</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">&lt;container name goes here&gt;</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#34;&lt;path/to/host/dir&gt;:&lt;path/to/guest/dir&gt;&#34;</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;&lt;host port&gt;:&lt;guest port&gt;&#34;</span>
    <span style="color:#f92672">environment</span>:
      - <span style="color:#ae81ff">variable=value</span>
</code></pre></div><h2 id="a-real-world-example-1">A real world example</h2>
<p>First, the minimal configuration is created to create a gitea server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">gitea</span>:
    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./ </span> <span style="color:#75715e"># The Dockerfile is located in the same directory as this file</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitea</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#34;$PWD/gitea_files/var/lib/gitea:/var/lib/gitea&#34;</span>
      - <span style="color:#e6db74">&#34;$PWD/gitea_files/etc/gitea:/etc/gitea&#34;</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;3000:3000&#34;</span>
</code></pre></div><p>The <code>version</code> entry is often set to <code>3</code> or <code>3.x</code>. If the given version is too old, docker-compose will start complaining. This <code>docker-compose.yml</code> file contains one service called <code>gitea</code>, with container name <code>gitea</code>.</p>
<p>Volumes are a mapped directory from guest to host, where <code>/var/lib/gitea</code> and <code>/etc/gitea</code> are folders inside the container. These two folders are mapped to <code>$PWD/gitea_files/var/lib/gitea</code> and <code>$PWD/gitea_files/etc/gitea</code> respectively. After the container has run at least one time, the container files can be viewed from the host OS by entering the <code>gitea_files</code> folder.</p>
<p>Normally, when no volumes are created, each container forgets what it was doing when it stops running. This is not very desireable. When there is a power outage for example, each container would have to be re-configured. When volumes are present in <code>docker-compose.yml</code>, Docker will automatically restore all files in the volumes based on the files from the host OS. This would mean that the gitea server will restore the files for <code>/var/lib/gitea</code> (where the git repositories are located) as well as <code>/etc/gitea</code> (where the configuration files are stored). All the other files in the container (like the binaries in <code>/usr/bin</code>) do not have to be restored, and thus do not need a volume.</p>
<h1 id="starting-the-container">Starting the container</h1>
<p>To start the docker container, the following command is executed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># build and start all containers</span>
docker-compose up --build
</code></pre></div><p>The gitea Docker container will now be built and run. The build process will only happen once. Next time the container is run, it will start without having to be built. The <code>--build</code> option can therefore be left out if a container is already built.</p>
<h2 id="testing-the-container">Testing the container</h2>
<p>If a browser is now opened and the url <code>http://localhost:3000</code> is visited, the gitea setup screen will appear. This means that the container is running as expected. An image of part of the setup screen is shown below:</p>
<p><a href="images/gitea_setup.png"><img src="images/gitea_setup.png" alt="Gitea setup with default options"></a></p>
<h2 id="adding-another-container">Adding another container</h2>
<p>By default, gitea is set to use a <code>SQLite3</code> SQL server. This SQL server is very lightweight, but can only handle one connection at a time. This would mean that gitea would stop working if multiple users started using it. This is not very desireable.</p>
<p>For this reason, another container will be created in the <code>docker-compose.yml</code>. This container will contain a complete MySQL server. The <code>docker-compose.yml</code> file will now look as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#75715e"># build gitea using a Dockerfile</span>
  <span style="color:#f92672">gitea</span>:
    <span style="color:#f92672">build</span>: <span style="color:#ae81ff">./</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">gitea</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#34;$PWD/gitea_files/var/lib/gitea:/var/lib/gitea&#34;</span>
      - <span style="color:#e6db74">&#34;$PWD/gitea_files/etc/gitea:/etc/gitea&#34;</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;3000:3000&#34;</span>

  <span style="color:#75715e"># add another container, containing a mysql image from docker hub</span>
  <span style="color:#f92672">db</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mariadb</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">mariadb</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#34;$PWD/mariadb_files/var/lib/mysql:/var/lib/mysql&#34;</span>
    <span style="color:#f92672">environment</span>:
      <span style="color:#f92672">MYSQL_ROOT_PASSWORD</span>: <span style="color:#ae81ff">example_root_password</span>
      <span style="color:#f92672">MYSQL_USER</span>: <span style="color:#ae81ff">example_user</span>
      <span style="color:#f92672">MYSQL_PASSWORD</span>: <span style="color:#ae81ff">example_password</span>
      <span style="color:#f92672">MYSQL_DATABASE</span>: <span style="color:#ae81ff">example_database</span>
</code></pre></div><p>A docker container containing a mariadb database server is now added to the list of containers. Another volume is created to make sure that all database related files are transferable to another computer at a later time.</p>
<p>When the containers are now (re) started using the command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># build and start all containers</span>
docker-compose up --build
</code></pre></div><p>the gitea container as well as a mariadb server is started.</p>
<h2 id="communication-between-containers">Communication between containers</h2>
<p>The cool thing about Docker containers is that they can talk to each other in a very nice way. How this works can be seen when configuring gitea. Normally, the IP address and port have to be inserted. Because the mariadb server is also a Docker container, gitea can be configured to talk to <code>mariadb:3306</code>. Docker will then automatically translate the <code>mariadb</code> part to the IP address of the mariadb container. This way, the two containers can always talk to each other. The database configuration for gitea now looks as follows:</p>
<p><a href="images/gitea_db_setup.png"><img src="images/gitea_db_setup.png" alt="Gitea database settings"></a></p>
<p>Gitea will always know where the database is, since Docker will always provide the right IP address (also when the docker containers are restarted later). In addition to that, both the gitea and database container will always run together.</p>
<p>Because the Dockerfile for the gitea server is so minimal, the option <code>Run as user</code> is changed from <code>gitea</code> to <code>root</code>, since the <code>gitea</code> user does not exist within the container (programs should run as a non-root user within a docker container if it&rsquo;s a production server!).</p>
<p>After all configurations are saved, the gitea server is operational and can be used to store projects.</p>
<h1 id="docker-images">Docker images</h1>
<p>For most containers on Docker Hub, the needed docker-compose configuration is given. For some images however, only a command to start a container is given. An example of this is an unofficial <a href="https://hub.docker.com/r/creativitykills/nginx-php-server">nginx and php image</a>. At the time of writing, the description contains the following command to start the container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -d -p 4488:80 --name<span style="color:#f92672">=</span>testapp -v $PWD:/var/www creativitykills/nginx-php-server
</code></pre></div><p>The options can be &ldquo;converted&rdquo; into a service and added to <code>docker-compose.yml</code> as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3&#39;</span>
<span style="color:#f92672">services</span>:
  <span style="color:#f92672">nginx_php</span>:
    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">creativitykills/nginx-php-server</span>
    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">testapp</span>
    <span style="color:#f92672">volumes</span>:
      - <span style="color:#e6db74">&#34;$PWD:/var/www&#34;</span>
    <span style="color:#f92672">ports</span>:
      - <span style="color:#e6db74">&#34;4488:80&#34;</span>
</code></pre></div><p>The docker image can now be managed by docker-compose and works exactly the same as it would without docker-compose.</p>
<h1 id="more-options">More options</h1>
<p>There are more options to Dockerfiles and docker-compose configurations. One example is setting up an <a href="https://hub.docker.com/r/erichough/nfs-server">nfs server container</a>, where the container has (to have) access to some parts of the host OS. For most of these images, the needed configurations/options are given.</p>
<h1 id="migrating-to-another-computer">Migrating to another computer</h1>
<p>Migrating to another computer is really simple: just copy the <code>Dockerfile</code>, <code>docker-compose.yml</code> and volume-directories to another computer. That&rsquo;s it! No need to configure a new OS. Just install Docker, copy the files, rebuild the container(s) and it&rsquo;s all done.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Docker is not too difficult to learn and is a great way to containerize many applications. Once a simple docker container is created using a <code>Dockerfile</code> and a <code>docker-compose.yml</code> file, many more features can be added. If there are containers that need to talk to eachother, it&rsquo;s all possible! And migrating the whole setup to another computer is just copying files, instead of re-configuring an entire OS.</p>
]]></content>
        </item>
        
        <item>
            <title>Creating a minimal OS using buildroot (Raspberry Pi)</title>
            <link>https://tomniesse.github.io/posts/buildroot/</link>
            <pubDate>Thu, 18 Nov 2021 13:28:55 +0200</pubDate>
            
            <guid>https://tomniesse.github.io/posts/buildroot/</guid>
            <description>What is an embedded OS? An Embedded Operating System is an Operating System designed to run on specific hardware. For example, many smart TV&amp;rsquo;s these days are running an embedded OS. Because the OS is made for the specific hardware, it can be configured to start up in the blink of an eye.
What is Buildroot? Buildroot, just like the yocto project, is a set of tools to help automate the build process of an embedded Linux based OS.</description>
            <content type="html"><![CDATA[<h1 id="what-is-an-embedded-os">What is an embedded OS?</h1>
<p>An Embedded Operating System is an Operating System designed to run on specific hardware. For example, many smart TV&rsquo;s these days are running an embedded OS. Because the OS is made for the specific hardware, it can be configured to start up in the blink of an eye.</p>
<h1 id="what-is-buildroot">What is Buildroot?</h1>
<p>Buildroot, just like the <a href="https://www.yoctoproject.org/">yocto project</a>, is a set of tools to help automate the build process of an embedded Linux based OS. Buildroot is configured through a set of configuration files, after which it builds an entire Linux based OS.</p>
<h1 id="what-are-the-benefits-of-creating-a-custom-embedded-os">What are the benefits of creating a custom embedded OS?</h1>
<p>There are a few great benefits to creating a custom embedded OS (and not using a prebuilt image file):</p>
<ul>
<li>The kernel and root filesystem can be seperated from the bootloader and stored on a remote server, to make the local system image really small.</li>
<li>If Buildroot is configured to only create a root filesystem, the resulting OS can run from a bootloader and/or kernel that is not built by Buildroot.</li>
<li>The U-boot bootloader is very configurable and can be configured to start the right kernel for the right Raspberry Pi board if needed. This includes downloading the right kernel (and device tree) from a remote server and then booting it.</li>
<li>The embedded OS built by buildroot supports many init systems (busybox, openrc, systemd, etc.).</li>
<li>The embedded OS is <em>very</em> minimal. This saves space and teaches how a Linux based OS works.</li>
<li>Almost any program that would normally run on Raspberry Pi OS (formerly called Raspbian) can easily be cross-compiled during the build process. This includes using CMake.</li>
<li>There are many debugging tools that can be built into the embedded OS to debug a certain application.</li>
<li>The cross-compiling toolchain can be fully configured within Buildroot. An external cross-compiling toolchain can also be used if desired (<a href="https://crosstool-ng.github.io">crosstool-NG</a> for example).</li>
</ul>
<h1 id="the-goal">The goal</h1>
<p>In this post, a basic Buildroot OS will be created. This will be a minimal build; it boots but is utterly useless. At the end of this post, the minimal Buildroot OS will be used for two other projects:</p>
<ul>
<li>Creating an OS that serves as an access point.</li>
<li>Cross-compiling <a href="https://liballeg.org">Allegro5</a> and <a href="https://dunedynasty.sourceforge.net">Dune Dynasty</a> and adding it to the minimal OS.</li>
</ul>
<p>The host PC has to run the latest version of Ubuntu.</p>
<h1 id="setting-up-a-cross-compiling-toolchain">Setting up a cross-compiling toolchain</h1>
<p>If the kernel is compiled using <code>arm-none-eabi-gcc</code> and the rest of the system is compiled using <code>aarch64-linux-gnu-gcc</code>, the system will not run. To ensure that the system runs (well) on the target board, a cross-compiling toolchain will be set up. This toolchain contains a cross-compiling <code>gcc</code>, <code>ld</code> and other tools that would normally be used to (cross-)compile a program or OS. The tools in the toolchain will be used to compile the whole system.</p>
<p>In this post, <a href="https://crosstool-ng.github.io">crosstool-NG</a> is used.</p>
<h2 id="downloading">Downloading</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/crosstool-ng/crosstool-ng
</code></pre></div><h2 id="compiling">Compiling</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./bootstrap <span style="color:#75715e"># only if crosstool-NG is cloned from github</span>
./configure --enable-local
make
</code></pre></div><h2 id="configuring-a-cross-compiling-toolchain">Configuring a cross-compiling toolchain</h2>
<p>The command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng list-samples
</code></pre></div><p>will give a list of possible targets to compile for. The entry <code>aarch64-rpi4-linux-gnu</code> is used by executing the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng aarch64-rpi4-linux-gnu
</code></pre></div><p>Because the GNU C library is quite big compared to something like uClibc, the <code>.config</code> file will be edited to use uClibc instead of the GNU C library. The goal is to make the target system a little smaller in disk size. The <code>.config</code> file is edited using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng menuconfig
</code></pre></div><p>The following changes were made inside the menuconfig menu:</p>
<ul>
<li>Under <code>C library</code>, the option <code>C library</code> is changed to <code>uClibc</code></li>
</ul>
<p>Then the menuconfig is exited and restarted to reload all options:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng menuconfig
</code></pre></div><ul>
<li>Under <code>C library</code>, the option <code>Add support for locales</code> is enabled</li>
<li>Under <code>C library</code>, the option <code>Add support for IPv6</code> is enabled</li>
<li>Under <code>C library</code>, the option <code>enable iconv</code> is enabled</li>
<li>Under <code>C library</code>, the option <code>Add support for fenv.h</code> is enabled</li>
<li>Under <code>C compiler</code>, the option <code>Version of gcc</code> is set to the second to latest version (at time of writing this was set to version <code>10.3.0</code>)</li>
<li>Under <code>C compiler</code>, the option <code>C++</code> is enabled</li>
<li>Under <code>Operating system</code>, the option <code>Version of linux</code> is set to the latest version (at time of writing this was version <code>5.15.2</code>)</li>
<li>Under <code>Debug facilities</code>, the option <code>gdb</code> is disabled (optional)</li>
<li>Under <code>Toolchain options</code>, the option <code>Tuple's alias</code> is set to <code>toolchain</code> (optional)</li>
</ul>
<h2 id="building-the-toolchain">Building the toolchain</h2>
<p>After the toolchain is configured, it can be built using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./ct-ng build -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
</code></pre></div><p>This build process will take a <em>long</em> time. Therefore, it should <em>not</em> be done in a (misconfigured) VM, but on a pc with lots of cores and/or threads. This can reduce the build time from a day to a few hours (maybe even less).</p>
<h2 id="checking-if-the-toolchain-works">Checking if the toolchain works</h2>
<p>After crosstool-NG is done creating a toolchain, a folder called <code>x-tools</code> can be found in the home-directory of the current user (<code>/home/$USER/x-tools</code>). Inside the <code>x-tools</code> directory, all cross-compiling toolchains can be found. To test if the new toolchain is the right version, the following command is executed inside <code>/home/$USER/x-tools/aarch64-rpi4-linux-uclibc/bin</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">toolchain-gcc -v
<span style="color:#75715e"># or, if the &#34;Tuple&#39;s alias&#34; option was not set when configuring the toolchain:</span>
aarch64-rpi4-linux-uclibc-gcc -v
</code></pre></div><p>The executed binary states that it is version <code>10.3.0</code>, just like the version that was specified in the menuconfig of crosstool-NG. For now, it is assumed that the binary will cross-compile without errors.</p>
<h1 id="creating-a-basic-buildroot-os">Creating a basic Buildroot OS</h1>
<h2 id="downloading-buildroot">Downloading Buildroot</h2>
<p>To get started, Buildroot can be downloaded from the <a href="https://buildroot.org/download.html">Buildroot website</a>. There are two download options to choose from; &ldquo;LTS&rdquo; or &ldquo;stable&rdquo;. For newer devices, the stable option is a good option. For this blog, the stable <em>.tar.gz</em> archive is used.</p>
<h2 id="extracting">Extracting</h2>
<p>To extract the <em>.tar.gz</em> file, the following command can be executed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">tar -xvf buildroot-&lt;VERSION_GOES_HERE&gt;.tar.gz
</code></pre></div><h2 id="initial-setup">Initial setup</h2>
<p>To view the target devices Buildroot can build systems for, the following command can be executed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make list-defconfigs
</code></pre></div><p>To configure Buildroot to build for the Raspberry Pi 4 (64 bit), the following command can be issued from the Buildroot directory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make raspberrypi4_64_defconfig
</code></pre></div><p>To then configure the system, run the following command:</p>
<h2 id="configuring-the-target-system">Configuring the target system</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make menuconfig
</code></pre></div><p>For this post, the following changed were made to the configuration:</p>
<ul>
<li>Under <code>Build options</code>, the option <code>Enable compiler cache</code> is enabled</li>
<li>Under <code>Bootloaders</code>, all the options are disabled (the bootloader will be compiled manually)</li>
<li>Under <code>Filesystem images</code>, the option <code>ext2/3/4 root filesystem</code> is disabled</li>
<li>Under <code>Filesystem images</code>, the option <code>tar the root filesystem</code> is enabled, along with the <code>Compression method</code> set to <code>gzip</code></li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain type</code> is set to <code>External toolchain</code> (this post uses a toolchain built by crosstool-NG)</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain</code> is set to <code>Custom toolchain</code></li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain origin</code> is set to <code>Pre-installed toolchain</code></li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain path</code> is set to <code>/home/&lt;YOUR_USERNAME_GOES_HERE&gt;/x-tools/aarch64-rpi4-linux-uclibc</code> (the path has to be absolute and may not contain <code>~/</code> or <code>/home/$USER/</code>!).</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain prefix</code> is set to <code>aarch64-rpi4-linux-uclibc</code></li>
<li>Under <code>Toolchain</code>, the option <code>External toolchain gcc version</code> is set to <code>10.x</code> (this version has to match the version from the cross-compiling toolchain)</li>
<li>Under <code>Toolchain</code>, the option <code>External toolchain kernel headers series</code> is set to <code>5.15.x or later</code> (this version has to match the version from the cross-compiling toolchain)</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has locale support?</code> is enabled</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has C++ support?</code> is enabled</li>
<li>Under <code>Toolchain</code>, the option <code>Toolchain has SSP support?</code> is enabled</li>
<li>Under <code>System configuration</code>, the option <code>System hostname</code> is set to <code>embedded</code></li>
<li>Under <code>System configuration</code>, the option <code>System banner</code> is set to <code>Welcome to embedded OS!</code></li>
<li>Under <code>System configuration</code>, the option <code>Root password</code> is set to <code>root</code> (for testing test builds)</li>
<li>Under <code>System configuration</code>, the option <code>/dev management</code> is set to <code>Dynamic using devtmpfs + mdev</code> (to load drivers automatically when the target device boots)</li>
</ul>
<p>Most linux desktops use <code>udev</code> to manage device drivers, but because this system uses <code>BusyBox</code> as init system, <code>mdev</code> is used. To enable <code>mdev</code> at boot, the file <code>buildroot-&lt;VERSION_GOES_HERE&gt;/board/raspberrypi/post-build.sh</code> needs the following extra lines at the bottom, leaving the rest of the file as is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cp package/busybox/S10mdev <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S10mdev
chmod <span style="color:#ae81ff">755</span> <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/init.d/S10mdev
cp package/busybox/mdev.conf <span style="color:#e6db74">${</span>TARGET_DIR<span style="color:#e6db74">}</span>/etc/mdev.conf
</code></pre></div><h2 id="building">Building</h2>
<p>To build the embedded OS, the following command can be executed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">make clean <span style="color:#f92672">&amp;&amp;</span> make
</code></pre></div><p>The reason for the <code>make clean</code> part is that Buildroot remembers <em>a lot</em>, and will sometimes refuse to build (correctly) because of a cached configuration.</p>
<h2 id="after-compiling">After compiling</h2>
<p>When buildroot is done compiling, a file called <code>rootfs.tar.gz</code> can be found in the <code>output/images</code> folder. This is the entire embedded OS, minus the bootloader. The bootloader will be compiled manually.</p>
<p>The same <code>output/images</code> folder also contains a linux image called <code>Image</code>. This image needs to be converted into a U-boot image (<code>uImage</code>)</p>
<p>In addition to the <code>rootfs.tar.gz</code> file being present, the folder <code>output/images</code> will also contain a folder called <code>rpi-firmware</code>.<br>
The files, <code>start4.elf</code> and <code>fixup4.dat</code> are needed later. These firmware files are files needed to boot the Raspberry Pi 4.</p>
<h2 id="converting-the-linux-image-into-a-uimage">Converting the linux Image into a uImage</h2>
<p>Buildroot created a file called <code>Image</code>. To make integrity checks at boot time possible, the image file will be converted to a U-boot image (<code>uImage</code>). This makes sure there are no memory errors before Linux starts booting.</p>
<p>To convert the linux image into a uImage, the package <code>u-boot-tools</code> is required. Then the <code>Image</code> file can be converted using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkimage -n <span style="color:#e6db74">&#39;Linux kernel&#39;</span> -A arm64 -O linux -C none -T kernel -a 0x00080000 -e 0x00080000 -d arch/arm64/boot/Image uImage
</code></pre></div><p>A file called <code>uImage</code> will now be created. This file contains the entire linux kernel binary, including some extra header stuff that <code>u-boot-tools</code> added. This file is the kernel which runs the system.</p>
<h1 id="adding-a-bootloader-u-boot">Adding a bootloader (U-boot)</h1>
<p>Although Buildroot can include the U-boot bootloader (among others) by enabling some settings, it might be nice to go a little more in depth to learn how U-boot actually works.</p>
<h2 id="downloading-u-boot">Downloading U-boot</h2>
<p>The U-boot bootloader can be downloaded from <a href="https://github.com/u-boot/u-boot">github</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone https://github.com/u-boot/u-boot
cd u-boot/
</code></pre></div><h2 id="configuring-the-u-boot-source">Configuring the U-boot source</h2>
<p>To see which default configurations U-boot has, execute the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ls configs
<span style="color:#75715e"># or, to only see raspberry pi entries</span>
ls configs | grep rpi
</code></pre></div><p>To create a basic configuration for the Raspberry Pi 4, the following command can be executed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>~/x-tools/aarch64-rpi4-linux-uclibc/bin/aarch64-rpi4-linux-uclibc- make rpi_4_defconfig
</code></pre></div><p>To then further configure the source, the <code>make menuconfig</code> command can be given:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>~/x-tools/aarch64-rpi4-linux-uclibc/bin/aarch64-rpi4-linux-uclibc- make menuconfig
</code></pre></div><p>In this post, the autoboot timer is changed from <code>2</code> to <code>0</code> for production-builds. This option can be changed in the following region:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Boot options -&gt;
    Autoboot options -&gt;
        delay in seconds before automatically booting
</code></pre></div><p>For test builds, it is recommended to leave this value as is.</p>
<h2 id="compiling-u-boot">Compiling U-boot</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ARCH<span style="color:#f92672">=</span>arm64 CROSS_COMPILE<span style="color:#f92672">=</span>~/x-tools/aarch64-rpi4-linux-uclibc/bin/aarch64-rpi4-linux-uclibc- make -j<span style="color:#e6db74">`</span>nproc<span style="color:#e6db74">`</span>
</code></pre></div><p>The compile process will not take long. After the compilation is complete, a file called <code>u-boot.bin</code> (the U-boot binary) will exist.</p>
<h2 id="creating-raspberry-pi-boot-configuration">Creating Raspberry Pi boot configuration</h2>
<p>Normally, the Raspberry Pi 4 boots a file called <code>kernel.img</code> (sometimes <code>kernel&lt;version number here&gt;.img</code>). In this post, the Raspberry Pi 4 should start the U-boot bootloader instead of the kernel. This can be done by creating a file called <code>config.txt</code> with the following content:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Enable UART communication</span>
enable_uart<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

<span style="color:#75715e"># Enable 64 bit mode</span>
arm_64bit<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

<span style="color:#75715e"># Make the raspberry Pi 4 start U-boot (u-boot.bin) instead of the default kernel8.img</span>
kernel<span style="color:#f92672">=</span>u-boot.bin

<span style="color:#75715e"># If the bluetooth device interferes with any uart/serial messages, uncomment this</span>
<span style="color:#75715e">#dtoverlay=miniuart-bt</span>

<span style="color:#75715e"># Uncomment to go fast</span>
<span style="color:#75715e">#arm_boost=1</span>

<span style="color:#75715e"># Uncomment to enable DRM VC4 V3D driver</span>
<span style="color:#75715e">#dtoverlay=vc4-kms-v3d</span>
<span style="color:#75715e">#max_framebuffers=2</span>

<span style="color:#75715e"># Uncomment to disable overscan</span>
<span style="color:#75715e">#disable_overscan=1</span>
</code></pre></div><h2 id="creating-a-u-boot-boot-script">Creating a U-boot boot script</h2>
<p>By default, when the U-boot bootloader starts up, it will look for a file called <code>boot.scr</code>. The <code>boot.scr</code> file is a boot script. This script will be used to load the kernel (<code>uImage</code>) and device tree (<code>bcm2711-rpi-4-b.dtb</code>) into memory and boot the system.</p>
<p>To create a bootscript, a file called <code>boot.txt</code> is created. This file will be converted to <code>boot.scr</code> and contains the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sleep <span style="color:#ae81ff">1</span> <span style="color:#75715e"># some SD cards are slow and will fail to list files in time</span>

echo +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
echo +-----------------------------------------------------------+
echo +----------------Embedded OS is starting!-------------------+
echo +-----------------------------------------------------------+
echo +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

echo ++++ Setting kernel parameters ++++++++++++++++++++++++++++++
setenv bootargs <span style="color:#e6db74">&#39;dwc_otg.lpm_enable=0 console=ttyAMA0,115200 console=tty1 kgdboc=ttyAMA0,115200 root=/dev/mmcblk0p2 rootwait&#39;</span>

echo ++++ Loading kernel into memory +++++++++++++++++++++++++++++
load mmc <span style="color:#ae81ff">0</span> $kernel_addr_r uImage

echo ++++ Loading device tree into memory ++++++++++++++++++++++++
load mmc <span style="color:#ae81ff">0</span> $fdt_addr_r bcm2711-rpi-4-b.dtb

echo ++++ Starting system ++++++++++++++++++++++++++++++++++++++++
bootm $kernel_addr_r - $fdt_addr_r
</code></pre></div><p>The <code>boot.txt</code> file is then converted to <code>boot.scr</code> using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkimage -A arm64 -O linux -T script -C none -a <span style="color:#ae81ff">0</span> -e <span style="color:#ae81ff">0</span> -n <span style="color:#e6db74">&#34;bootscript&#34;</span> -d boot.txt boot.scr
</code></pre></div><h1 id="creating-a-system-image">Creating a system image</h1>
<h2 id="creating-an-image-file">Creating an image file</h2>
<p>To create partitions, the program <code>parted</code> will be used. There will be two partitions: a boot partition called <code>BOOT</code> and a root partition called <code>ROOTFS</code>. The boot partition will have a fat16 filesystem and the root filesystem will use the ext4 filesystem.</p>
<p>To prevent disks from being destroyed, a virtual disk image will be created using dd:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># create a file called `system.img` with a size of 600MiB</span>
dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>/dev/zero of<span style="color:#f92672">=</span>system.img bs<span style="color:#f92672">=</span>1MiB count<span style="color:#f92672">=</span><span style="color:#ae81ff">600</span> status<span style="color:#f92672">=</span>progress
</code></pre></div><p>Then, this virtual disk image will be partitioned using <code>parted</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">parted system.img
</code></pre></div><p>Within <code>parted</code>, run the <code>mklabel</code> command and set the partition table type to <code>msdos</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> mklabel msdos
</code></pre></div><p>Then create the boot and root partitions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> mkpart primary fat16 2048s 30MiB
<span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> mkpart primary ext4 30MiB 100%
<span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> set <span style="color:#ae81ff">1</span> boot on
<span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> print
</code></pre></div><p>When done, exit parted by entering <code>quit</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">(</span>parted<span style="color:#f92672">)</span> quit
</code></pre></div><h2 id="partitioning-the-system-image">Partitioning the system image</h2>
<p>First, mount the virtual disk image as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Create a variable for the mount drive path</span>
SYSTEM_IMAGE<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>sudo losetup -Pf system.img --show<span style="color:#e6db74">`</span>
</code></pre></div><p>Normally, disk devices in linux have paths like <code>/dev/sda</code>, <code>/dev/sdb</code>, <code>/dev/mmcblk0</code>, etc. This virtual device will have the path <code>/dev/loop0</code>. Multiple virtual devices can be mounted. The next mounted virtual disks will have the path <code>/dev/loop1</code>, <code>/dev/loop2</code>, <code>/dev/loop3</code>, etc.</p>
<p>In this post, the path to the virtual disk is stored in the <code>SYSTEM_IMAGE</code> variable. To view the path to the virtual disk device, run the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo $SYSTEM_IMAGE
</code></pre></div><p>Then, partition it using the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Create actual partitions for boot and rootfs now</span>
sudo mkfs.vfat -n BOOT <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p1&#34;</span><span style="color:#e6db74">`</span>   <span style="color:#75715e"># Create a fat16 partition for boot files</span>
sudo mkfs.ext4 -L ROOTFS <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p2&#34;</span><span style="color:#e6db74">`</span> <span style="color:#75715e"># Create an ext4 partition for rootfs files</span>
</code></pre></div><h2 id="mounting-the-partitions">Mounting the partitions</h2>
<p>To mount the system image, use the following commands to mount the virtual disk image to a folder called <code>target_mnt</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir ./target_mnt
sudo mount <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p2&#34;</span><span style="color:#e6db74">`</span> ./target_mnt
sudo mkdir ./target_mnt/boot
sudo mount <span style="color:#e6db74">`</span>echo <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>SYSTEM_IMAGE<span style="color:#e6db74">}</span><span style="color:#e6db74">p1&#34;</span><span style="color:#e6db74">`</span> ./target_mnt/boot
</code></pre></div><h2 id="copying-boot-files">Copying boot files</h2>
<p>First, all required firmware files will be copied from the buildroot output folder to the boot folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo cp ./buildroot-&lt;VERSION_GOES_HERE&gt;/output/images/bcm2711-rpi-4-b.dtb ./target_mnt/boot/
sudo cp ./buildroot-&lt;VERSION_GOES_HERE&gt;/output/images/rpi-firmware/start4.elf ./target_mnt/boot/
sudo cp ./buildroot-&lt;VERSION_GOES_HERE&gt;/output/images/rpi-firmware/fixup4.dat ./target_mnt/boot/
</code></pre></div><p>Then, the kernel is copied to the boot folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo cp ./buildroot-&lt;VERSION_GOES_HERE&gt;/output/images/uImage ./target_mnt/boot/
</code></pre></div><p>After that, the bootloader and related configurations are copied to the boot folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Copy the bootloader</span>
sudo cp ./u-boot/u-boot.bin ./target_mnt/boot/

<span style="color:#75715e"># Copy config.txt, so the Raspberry Pi boots U-boot instead of &#34;kernel.img&#34;</span>
sudo cp ./u-boot/config.txt ./target_mnt/boot/

<span style="color:#75715e"># Copy boot.scr, this bootscript tells U-boot to start the embedded OS</span>
sudo cp ./u-boot/boot.scr ./target_mnt/boot/
</code></pre></div><h2 id="extracting-the-root-filesystem-to-the-rootfs-partition">Extracting the root filesystem to the <code>ROOTFS</code> partition</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd ./target_mnt
sudo tar -xvf ../buildroot-&lt;VERSION_GOES_HERE&gt;/output/images/rootfs.tar.gz .
cd ../
</code></pre></div><h2 id="unmounting-the-image">Unmounting the image</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo sync
sudo umount ./target_mnt/boot -l
sudo umount ./target_mnt -l
sudo losetup -D
sudo rm -rf ./target_mnt
</code></pre></div><h1 id="flashing-the-virtual-disk-image-to-an-sd">Flashing the virtual disk image to an SD</h1>
<p>The <code>system.img</code> file (which now contains the entire embedded OS) can be flashed to an SD card using <code>dd</code> as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo dd <span style="color:#66d9ef">if</span><span style="color:#f92672">=</span>system.img of<span style="color:#f92672">=</span>/dev/YOUR_DEVICE_GOES_HERE bs<span style="color:#f92672">=</span>1MiB status<span style="color:#f92672">=</span>progress
sudo sync
</code></pre></div><p>Since <code>system.img</code> is an image file the flashing process is exactly the same as all other &ldquo;Raspberry Pi Linux distro&rsquo;s&rdquo;.<br>
Therefore, if <code>dd</code> seems too scary, the following tools can be used to flash the <code>system.img</code> file:<br>
<a href="https://www.raspberrypi.com/software">Raspberry Pi Imager</a>,<br>
<a href="https://www.balena.io/etcher">Etcher</a>,<br>
<a href="https://wiki.gnome.org/Apps/Disks">GNOME Disks</a> or<br>
<a href="https://community.chocolatey.org/packages/win32diskimager">Win32 Disk Imager</a>.</p>
<!-- # Extra's

There are two other posts that use this basic buildroot OS to create two other projects:

- [Creating an access point](/?blog%2Fbuildroot_routerOS)
- [Adding Allegro5 and a Dune Dynasty remake to the basic Buildroot OS](/?blog%2Fbuildroot_dune_dynasty) -->
<h1 id="sources">Sources</h1>
<ul>
<li><a href="https://bootlin.com/doc/training/buildroot/buildroot-slides.pdf">https://bootlin.com/doc/training/buildroot/buildroot-slides.pdf</a></li>
<li><a href="https://blog.crysys.hu/2018/06/enabling-wifi-and-converting-the-raspberry-pi-into-a-wifi-ap/">https://blog.crysys.hu/2018/06/enabling-wifi-and-converting-the-raspberry-pi-into-a-wifi-ap/</a></li>
<li><a href="https://unix.stackexchange.com/questions/439559/udhcpc-no-lease-failing-when-booting-on-embedded-linux-created-by-buildroot">https://unix.stackexchange.com/questions/439559/udhcpc-no-lease-failing-when-booting-on-embedded-linux-created-by-buildroot</a></li>
<li><a href="https://raspberrypi.stackexchange.com/questions/107858/raspberry-pi-4-b-5ghz-wifi-access-point-problem">https://raspberrypi.stackexchange.com/questions/107858/raspberry-pi-4-b-5ghz-wifi-access-point-problem</a></li>
<li><a href="http://lists.busybox.net/pipermail/buildroot/2019-June/252256.html">http://lists.busybox.net/pipermail/buildroot/2019-June/252256.html</a></li>
</ul>
]]></content>
        </item>
        
        <item>
            <title>C and SDL2 programming</title>
            <link>https://tomniesse.github.io/posts/c-sdl2-programming/</link>
            <pubDate>Thu, 04 Nov 2021 13:28:55 +0200</pubDate>
            
            <guid>https://tomniesse.github.io/posts/c-sdl2-programming/</guid>
            <description>Working with SDL2 and C This post will show snippets of code that can be used to make an SDL2 application. This post serves mostly as a personal reminder of how the basics of SDL2 work. Much more advanced things can be done using SDL2, especially if it&amp;rsquo;s combined with a language like C++. C++ has classes, which make it much easier to create more advanced programs (like a basic game).</description>
            <content type="html"><![CDATA[<h1 id="working-with-sdl2-and-c">Working with SDL2 and C</h1>
<p>This post will show snippets of code that can be used to make an SDL2 application. This post serves mostly as a personal reminder of how the basics of SDL2 work. Much more advanced things can be done using SDL2, especially if it&rsquo;s combined with a language like C++. C++ has classes, which make it much easier to create more advanced programs (like a basic game).</p>
<h2 id="what-is-sdl2">What is SDL2?</h2>
<p>The libSDL <a href="https://www.libsdl.org/">website</a> describes the software as follows:</p>
<blockquote>
<p>&ldquo;Simple DirectMedia Layer is a cross-platform development library designed to provide low level access to<br>
audio, keyboard, mouse, joystick, and graphics hardware via OpenGL and Direct3D.&rdquo;</p>
</blockquote>
<p>So, SDL2 is not like visual studio where you can drag and drop buttons into place. It is a lower level library which can draw 2D lines, squares, images and text. That&rsquo;s it. If you want buttons, you create them yourself. If you want some sort of clickable menu, you have to create it. SDL2 does help a lot by making difficult parts easier, for example the ability to play audio or display an image on the screen.</p>
<h2 id="creating-a-window-that-opens-and-closes">Creating a window that opens and closes</h2>
<p>Before any drawing can begin, a window and renderer have to be created. After the program window opens and closes without errors, other elements can be created.</p>
<p>Code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stddef.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;math.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SDL2/SDL.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SDL2/SDL_image.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SDL2/SDL_ttf.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SDL2/SDL_mixer.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define WINDOW_WIDTH 640
</span><span style="color:#75715e">#define WINDOW_HEIGHT 480
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sdl2_create_window</span>(SDL_Window<span style="color:#f92672">**</span> window, SDL_Renderer<span style="color:#f92672">**</span> renderer, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> window_title) {
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> window_flags <span style="color:#f92672">=</span> SDL_WINDOW_RESIZABLE;
    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> renderer_flags <span style="color:#f92672">=</span> SDL_RENDERER_PRESENTVSYNC <span style="color:#f92672">|</span> SDL_RENDERER_ACCELERATED; <span style="color:#75715e">// Use hardware rendering and vsync
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> (SDL_Init(SDL_INIT_VIDEO) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
        printf(<span style="color:#e6db74">&#34;Couldn&#39;t initialize SDL: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, SDL_GetError());
        exit(<span style="color:#ae81ff">1</span>);
    }

    <span style="color:#f92672">*</span>window <span style="color:#f92672">=</span> SDL_CreateWindow(window_title, SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED, WINDOW_WIDTH, WINDOW_HEIGHT, window_flags);
    <span style="color:#66d9ef">if</span> (window <span style="color:#f92672">==</span> NULL) {
        printf(<span style="color:#e6db74">&#34;Failed to create window: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, SDL_GetError());
        exit(<span style="color:#ae81ff">1</span>);
    }

    <span style="color:#f92672">*</span>renderer <span style="color:#f92672">=</span> SDL_CreateRenderer(<span style="color:#f92672">*</span>window, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, renderer_flags);
    <span style="color:#66d9ef">if</span> (renderer <span style="color:#f92672">==</span> NULL) {
        printf(<span style="color:#e6db74">&#34;Failed to create renderer: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, SDL_GetError());
        exit(<span style="color:#ae81ff">1</span>);
    }
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    SDL_Window<span style="color:#f92672">*</span> window <span style="color:#f92672">=</span> NULL;
    SDL_Renderer<span style="color:#f92672">*</span> renderer <span style="color:#f92672">=</span> NULL;
    SDL_Event event;
    <span style="color:#66d9ef">bool</span> running <span style="color:#f92672">=</span> true;

    <span style="color:#75715e">// Create a new window to run the in
</span><span style="color:#75715e"></span>    sdl2_create_window(<span style="color:#f92672">&amp;</span>window, <span style="color:#f92672">&amp;</span>renderer, <span style="color:#e6db74">&#34;SDL2 example&#34;</span>);

	<span style="color:#75715e">// Main loop
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(running) {
		SDL_SetRenderDrawColor(renderer, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, SDL_ALPHA_OPAQUE);
        SDL_RenderClear(renderer);

        <span style="color:#75715e">// Do rendering here
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">// Check if the close button is pressed
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// and break out of the loop if it is.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(SDL_PollEvent(<span style="color:#f92672">&amp;</span>event)) {
			<span style="color:#66d9ef">if</span>(event.type <span style="color:#f92672">==</span> SDL_QUIT) {
				<span style="color:#75715e">// The program needs to stop running!
</span><span style="color:#75715e"></span>				running <span style="color:#f92672">=</span> false;
			}
		}

        SDL_RenderPresent(renderer);
    }

    <span style="color:#75715e">// Stop everything
</span><span style="color:#75715e"></span>    SDL_DestroyRenderer(renderer);
    SDL_DestroyWindow(window);
    SDL_Quit();

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>Makefile to create the binary:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile">CC <span style="color:#f92672">=</span> gcc
CFLAGS <span style="color:#f92672">=</span> -std<span style="color:#f92672">=</span>c99 -Wall -Wextra -Wconversion -Ofast -Wpedantic -Werror <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>         <span style="color:#e6db74">`</span>sdl2-config --cflags<span style="color:#e6db74">`</span> -lSDL2 -lSDL2_ttf -lSDL2_image -lSDL2_mixer -lm

<span style="color:#a6e22e">all</span><span style="color:#f92672">:</span>
	@echo Building...
	<span style="color:#66d9ef">$(</span>CC<span style="color:#66d9ef">)</span> src/main.c -o main <span style="color:#66d9ef">$(</span>CFLAGS<span style="color:#66d9ef">)</span>
</code></pre></div><p>When the resulting binary is executed, the follwing empty window should appear:</p>
<p><a href="images/example_window.png"><img src="images/example_window.png" alt="SDL2 empty window"></a></p>
<h2 id="small-code-examples">Small code examples</h2>
<h3 id="drawing-a-line">Drawing a line</h3>
<p>To draw a line over the whole window, the following code can be used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Get begin and end values for the line
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> x_start <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> y_start <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">int</span> x_end, y_end;
<span style="color:#75715e">// Make sure the line ends at the bottom right of the screen
</span><span style="color:#75715e"></span>SDL_GetWindowSize(window, <span style="color:#f92672">&amp;</span>x_end, <span style="color:#f92672">&amp;</span>y_end);

<span style="color:#75715e">// Set the line color
</span><span style="color:#75715e"></span>SDL_SetRenderDrawColor(renderer, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, SDL_ALPHA_OPAQUE);
<span style="color:#75715e">// Draw the line
</span><span style="color:#75715e"></span>SDL_RenderDrawLine(renderer, x_start, y_start, x_end, y_end);
</code></pre></div><p>If the application is now compiled and run again, a line should appear on the screen, going from the top left <code>(0,0)</code> to the bottom right <code>(&lt;window width&gt;,&lt;window height&gt;)</code>. The line also changes shape when the window gets resized:</p>
<p><a href="images/sdl2_line_high.png"><img src="images/sdl2_line_high.png" alt="SDL2 high line"></a></p>
<p><a href="images/sdl2_line_wide.png"><img src="images/sdl2_line_wide.png" alt="SDL2 wide line"></a></p>
<h2 id="drawing-a-rectangle">Drawing a rectangle</h2>
<p>Drawing a rectangle is something SDL2 can do by itself. It can either draw only the outline or fill it in with a color.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#75715e">// Set draw color
</span><span style="color:#75715e"></span>SDL_SetRenderDrawColor(renderer, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">255</span>, SDL_ALPHA_OPAQUE);

<span style="color:#75715e">// Create a rectangle
</span><span style="color:#75715e"></span>SDL_Rect example_rectangle;
example_rectangle.x <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;	<span style="color:#75715e">// Set horizontal top left coordinate
</span><span style="color:#75715e"></span>example_rectangle.y <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;	<span style="color:#75715e">// Set vertical top left coordinate
</span><span style="color:#75715e"></span>example_rectangle.w <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;	<span style="color:#75715e">// Set width
</span><span style="color:#75715e"></span>example_rectangle.h <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;	<span style="color:#75715e">// Set height
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Draw a colored rectangle
</span><span style="color:#75715e"></span>SDL_RenderDrawRect(renderer, <span style="color:#f92672">&amp;</span>example_rectangle);
<span style="color:#75715e">// Or, to fill in the rectangle as well
</span><span style="color:#75715e">//SDL_RenderFillRect(renderer, &amp;example_rectangle);
</span></code></pre></div><p><a href="images/sdl2_rectangle.png"><img src="images/sdl2_rectangle.png" alt="SDL2 rectangle"></a></p>
<h2 id="drawing-a-circle">Drawing a circle</h2>
<p>Drawing a circle is not something SDL2 can do by itself, but it can be done using a function and a custom datatype:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Create a datatype called &#34;SDL_Circle&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#66d9ef">int</span> x, y, r;	<span style="color:#75715e">// point x, point y, radius
</span><span style="color:#75715e"></span>} SDL_Circle;

SDL_Circle circle;
circle.x <span style="color:#f92672">=</span> <span style="color:#ae81ff">240</span>;
circle.y <span style="color:#f92672">=</span> <span style="color:#ae81ff">240</span>;
circle.r <span style="color:#f92672">=</span> <span style="color:#ae81ff">240</span>;

<span style="color:#75715e">// Render a circle by drawing 360 lines
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SDL_RenderDrawCircle</span>(SDL_Renderer<span style="color:#f92672">*</span> renderer, <span style="color:#66d9ef">const</span> SDL_Circle<span style="color:#f92672">*</span> circle) {
	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">double</span> PI <span style="color:#f92672">=</span> acos(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
	<span style="color:#66d9ef">double</span> angle <span style="color:#f92672">=</span> <span style="color:#ae81ff">360</span>;
	<span style="color:#66d9ef">do</span> {
		<span style="color:#75715e">// Calculate a point
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">double</span> rotation <span style="color:#f92672">=</span> angle <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>PI <span style="color:#f92672">/</span> <span style="color:#ae81ff">360</span>;
		<span style="color:#66d9ef">double</span> point_x_start <span style="color:#f92672">=</span> circle<span style="color:#f92672">-&gt;</span>x <span style="color:#f92672">+</span> cos(rotation) <span style="color:#f92672">*</span> circle<span style="color:#f92672">-&gt;</span>r;
		<span style="color:#66d9ef">double</span> point_y_start <span style="color:#f92672">=</span> circle<span style="color:#f92672">-&gt;</span>y <span style="color:#f92672">+</span> sin(rotation) <span style="color:#f92672">*</span> circle<span style="color:#f92672">-&gt;</span>r;

		<span style="color:#75715e">// Calculate the next point
</span><span style="color:#75715e"></span>		rotation <span style="color:#f92672">=</span> (angle<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>PI <span style="color:#f92672">/</span> <span style="color:#ae81ff">360</span>;
		<span style="color:#66d9ef">double</span> point_x_end <span style="color:#f92672">=</span> circle<span style="color:#f92672">-&gt;</span>x <span style="color:#f92672">+</span> cos(rotation) <span style="color:#f92672">*</span> circle<span style="color:#f92672">-&gt;</span>r;
		<span style="color:#66d9ef">double</span> point_y_end <span style="color:#f92672">=</span> circle<span style="color:#f92672">-&gt;</span>y <span style="color:#f92672">+</span> sin(rotation) <span style="color:#f92672">*</span> circle<span style="color:#f92672">-&gt;</span>r;

		<span style="color:#75715e">// Draw a line between the two points
</span><span style="color:#75715e"></span>		SDL_RenderDrawLine(renderer, (<span style="color:#66d9ef">int</span>)point_x_start, (<span style="color:#66d9ef">int</span>)point_y_start, (<span style="color:#66d9ef">int</span>)point_x_end, (<span style="color:#66d9ef">int</span>)point_y_end);
	} <span style="color:#66d9ef">while</span>(angle<span style="color:#f92672">--&gt;</span><span style="color:#ae81ff">1</span>);
}

<span style="color:#75715e">// in the main loop, call the function as follows after setting the right color:
</span><span style="color:#75715e"></span>SDL_RenderDrawCircle(renderer, <span style="color:#f92672">&amp;</span>circle);
</code></pre></div><p>This results in the following drawing being made:</p>
<p><a href="images/sdl2_circle.png"><img src="images/sdl2_circle.png" alt="SDL2 circle"></a></p>
<h2 id="drawing-an-image">Drawing an image</h2>
<p>SDL2 can draw images as sprites:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Enable support for JPG, PNG and/or TIF before creating the window
</span><span style="color:#75715e"></span>IMG_Init(IMG_INIT_JPG<span style="color:#f92672">|</span>IMG_INIT_PNG<span style="color:#f92672">|</span>IMG_INIT_TIF);

<span style="color:#75715e">// Import image files before running the main loop
</span><span style="color:#75715e"></span>SDL_Texture<span style="color:#f92672">*</span> example_texture <span style="color:#f92672">=</span> IMG_LoadTexture(renderer, <span style="color:#e6db74">&#34;image.jpg&#34;</span>);

<span style="color:#75715e">// Render the texture inside the main loop
</span><span style="color:#75715e"></span>SDL_Rect dstrect;
<span style="color:#66d9ef">int</span> rotation <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
dstrect.x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
dstrect.y <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
SDL_GetWindowSize(window, <span style="color:#f92672">&amp;</span>dstrect.w, <span style="color:#f92672">&amp;</span>dstrect.h);
SDL_RenderCopyEx(renderer, example_texture, NULL, <span style="color:#f92672">&amp;</span>dstrect, rotation, NULL, SDL_FLIP_NONE);

<span style="color:#75715e">// After the main window, before the window closes, run IMG_Quit();
</span><span style="color:#75715e"></span>IMG_Quit();
</code></pre></div><p>This results in the image being drawn on the screen:</p>
<p><a href="images/sdl2_image_rendering.png"><img src="images/sdl2_image_rendering.png" alt="SDL2 image rendering"></a></p>
<h2 id="playing-audio">Playing audio</h2>
<p>To play audio, the following code can be used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Initialize audio before the main loop
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> number_of_channels <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;    <span style="color:#75715e">// SDL2 will play max 50 audio clips at the same time
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">if</span>(Mix_OpenAudio(<span style="color:#ae81ff">44100</span>, AUDIO_S16SYS, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">512</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
    fprintf(stderr, <span style="color:#e6db74">&#34;Could not open audio: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, SDL_GetError());
    exit(<span style="color:#ae81ff">1</span>);
}
<span style="color:#66d9ef">if</span>(Mix_AllocateChannels(number_of_channels) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
    fprintf(stderr, <span style="color:#e6db74">&#34;Could not allocate mixing channels: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, SDL_GetError());
    exit(<span style="color:#ae81ff">1</span>);
}

<span style="color:#75715e">// Before the main loop, import all audio files as mix chunks
</span><span style="color:#75715e"></span>Mix_Chunk<span style="color:#f92672">*</span> example_audio <span style="color:#f92672">=</span> Mix_LoadWAV(<span style="color:#e6db74">&#34;audio.wav&#34;</span>);

<span style="color:#75715e">// During the main loop, when audio needs to play, it can be done using the following code
</span><span style="color:#75715e"></span>Mix_PlayChannel(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, example_audio, <span style="color:#ae81ff">0</span>);  <span style="color:#75715e">// -1 automatically selects the first available audio channel
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// After the main loop, before the program shuts down, make sure to close the audio mixer
</span><span style="color:#75715e"></span>Mix_CloseAudio();
</code></pre></div><h2 id="rendering-text">Rendering text</h2>
<p>To render text in SDL2, a font file with the extension <em>.ttf</em> is needed. It is to be placed in the same directory as the binary, or in a subdirectory within the project.</p>
<p>First, enable font support and load a font by running the code below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">TTF_Init();
<span style="color:#66d9ef">int</span> font_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>;
TTF_Font<span style="color:#f92672">*</span> font <span style="color:#f92672">=</span> TTF_OpenFont(<span style="color:#e6db74">&#34;path/to/font-file.ttf&#34;</span>, font_size);
</code></pre></div><p>Then, to render text on the screen using this font, the following function can be used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">text_render</span>(SDL_Renderer<span style="color:#f92672">*</span> renderer, TTF_Font<span style="color:#f92672">*</span> font, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> message, <span style="color:#66d9ef">int</span> position_x, <span style="color:#66d9ef">int</span> position_y, <span style="color:#66d9ef">int</span> rotation_angle, <span style="color:#66d9ef">bool</span> center, SDL_Color<span style="color:#f92672">*</span> text_color) {
    <span style="color:#75715e">// Declare variables that will contain text size values generated by TTF_SizeText()
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> text_width;
    <span style="color:#66d9ef">int</span> text_height;

    <span style="color:#75715e">// Tell SDL2 to convert the imported ttf file and message into a texture
</span><span style="color:#75715e"></span>    SDL_Surface<span style="color:#f92672">*</span> message_surface <span style="color:#f92672">=</span> TTF_RenderText_Solid(font, message, <span style="color:#f92672">*</span>text_color);
    SDL_Texture<span style="color:#f92672">*</span> message_texture <span style="color:#f92672">=</span> SDL_CreateTextureFromSurface(renderer, message_surface);

    <span style="color:#75715e">// Define dimensions of the text
</span><span style="color:#75715e"></span>    TTF_SizeText(font, message, <span style="color:#f92672">&amp;</span>text_width, <span style="color:#f92672">&amp;</span>text_height);
    SDL_Rect message_rect;
    <span style="color:#66d9ef">if</span>(center) {
        message_rect.x <span style="color:#f92672">=</span> position_x <span style="color:#f92672">-</span> (text_width <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>);
        message_rect.y <span style="color:#f92672">=</span> position_y <span style="color:#f92672">-</span> (text_height <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>);
    } <span style="color:#66d9ef">else</span> {
        message_rect.x <span style="color:#f92672">=</span> position_x;
        message_rect.y <span style="color:#f92672">=</span> position_y;
    }
    message_rect.w <span style="color:#f92672">=</span> text_width;
    message_rect.h <span style="color:#f92672">=</span> text_height;

    <span style="color:#75715e">// Add the text to the rendering queue.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// SDL_RenderCopy(renderer, message_texture, NULL, &amp;message_rect);
</span><span style="color:#75715e"></span>    SDL_RenderCopyEx(renderer, message_texture, NULL, <span style="color:#f92672">&amp;</span>message_rect, rotation_angle, NULL, SDL_FLIP_NONE);

    <span style="color:#75715e">// Delete the texture, since it&#39;s written to the screen already
</span><span style="color:#75715e"></span>    SDL_FreeSurface(message_surface);
    SDL_DestroyTexture(message_texture);
}
</code></pre></div><p>The function can now be called somewhere in <code>main()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// Define a text color
</span><span style="color:#75715e"></span>SDL_Color color;
color.r <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;               <span style="color:#75715e">// red
</span><span style="color:#75715e"></span>color.g <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;               <span style="color:#75715e">// green
</span><span style="color:#75715e"></span>color.b <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;               <span style="color:#75715e">// blue
</span><span style="color:#75715e"></span>color.a <span style="color:#f92672">=</span> SDL_ALPHA_OPAQUE;  <span style="color:#75715e">// alpha
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Define the message
</span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Example text&#34;</span>;

<span style="color:#75715e">// Render it all in the main loop
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> x_end, y_end;
SDL_GetWindowSize(window, <span style="color:#f92672">&amp;</span>x_end, <span style="color:#f92672">&amp;</span>y_end);
text_render(renderer, font, message, x_end <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, y_end <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>, true, <span style="color:#f92672">&amp;</span>color);
</code></pre></div><p>Just before the window is closed, <code>TTF_Quit()</code> needs to be called to free some memory.</p>
<p>This will result in the following window being shown:</p>
<p><a href="images/sdl2_example_text.png"><img src="images/sdl2_example_text.png" alt="SDL2 text rendering"></a></p>
<h2 id="keyboard-input">Keyboard input</h2>
<h3 id="game-like-keyboard-input">Game-like keyboard input</h3>
<p>todo</p>
<h3 id="program-like-keyboard-input">Program-like keyboard input</h3>
<p>todo</p>
<h2 id="mouse-input">Mouse input</h2>
<p>todo</p>
<h2 id="controller-input">Controller input</h2>
<p>todo</p>
]]></content>
        </item>
        
        <item>
            <title>Programming a character device driver (PinePhone and Linux)</title>
            <link>https://tomniesse.github.io/posts/pinephone-linux-kernel-programming/</link>
            <pubDate>Wed, 03 Nov 2021 13:28:55 +0200</pubDate>
            
            <guid>https://tomniesse.github.io/posts/pinephone-linux-kernel-programming/</guid>
            <description>Introduction This page describes the process of writing a kernel module that can toggle an LED inside a PinePhone UBports edition.
Using the user manual of the phone&amp;rsquo;s processor (Allwinner A64), a kernel module will be written that can control the RGB-LED of the phone.
What is a kernel module? A kernel is a piece of software that handles all the communications between hardware and software. The linux kernel uses modules for this.</description>
            <content type="html"><![CDATA[<h1 id="introduction">Introduction</h1>
<p>This page describes the process of writing a kernel module that can toggle an LED inside a PinePhone UBports edition.<br>
Using the user manual of the phone&rsquo;s processor (Allwinner A64), a kernel module will be written that can control the RGB-LED of the phone.</p>
<h1 id="what-is-a-kernel-module">What is a kernel module?</h1>
<p>A kernel is a piece of software that handles all the communications between hardware and software. The linux kernel uses modules for this. Only the kernel and it&rsquo;s modules are allowed to read/write to/from hardware.</p>
<h1 id="the-goal">The goal</h1>
<p>The goal of this little project is to create a linux module that turns the built-in RGB-LED of the PinePhone UBports edition on or off. The same approach can be used to control GPIO ports on other embedded systems, like Raspberry Pi&rsquo;s. How cool would it be to understand the magic behind packages like <a href="http://wiringpi.com/wiringpi-deprecated">wiringPi</a>?</p>
<h1 id="reading-schematics">Reading schematics</h1>
<p>The Pine64 website hosts a <a href="http://files.pine64.org/doc/PinePhone/PinePhone%20v1.2%20Released%20Schematic.pdf">schematic</a>, which tells how the PinePhone is wired on the inside. Page 11 says how the RGB-led is connected:</p>
<p><a href="images/pinephone_led_schematic.png"><img src="images/pinephone_led_schematic.png" alt="LED schematic"></a></p>
<ul>
<li>PD18-LED-R is connected to B+</li>
<li>PD19-LED-G is connected to R+</li>
<li>PD20-LED-B is connected to G+</li>
</ul>
<h1 id="figuring-out-how-to-control-the-io-pins">Figuring out how to control the IO pins</h1>
<p>The schematic provided enough information. It&rsquo;s now time to start digging into the workings of the Allwinner A64 SoC. The A64 SoC has two lenghty documents;</p>
<ul>
<li>The <a href="https://files.pine64.org/doc/datasheet/pine64/A64_Datasheet_V1.1.pdf">datasheet</a> provides information about how to integrate the A64 SoC into a project and focuses on the electronic side of things.</li>
<li>The <a href="https://linux-sunxi.org/images/b/b4/Allwinner_A64_User_Manual_V1.1.pdf">user manual</a> contains information about how the SoC works and contains information about the different registers present in the SoC.</li>
</ul>
<p>For this project, only the user manual will be used, as it contains all the required information.</p>
<h2 id="finding-the-right-registers">Finding the right registers</h2>
<p>Chapter 3.21 (page 376) of the <a href="https://linux-sunxi.org/images/b/b4/Allwinner_A64_User_Manual_V1.1.pdf">user manual</a> contains information about some of the registers in the A64 SoC. At the top of the page, the following text can be read:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">The chip has 7 ports for multi-functional input/out pins. They are shown below:
- Port B(PB): 10 input/output port
- Port C(PC): 17 input/output port
- Port D(PD): 25 input/output port
- Port E(PE): 18 input/output port
- Port F(PF): 7 input/output port
- Port G(PG): 14 input/output port
- Port H(PH): 12 input/output port
</code></pre></div><p>Port D is the one that will be controlled (<code>PD18</code>, <code>PD19</code> and <code>PD20</code>).</p>
<p>Further down the same page, some memory offsets are shown. This is because the RGB led is connected using MMIO (Memory Mapped IO). When a certain part of memory is altered, the corresponding IO port will turn on or off. There are a few configure registers (which set pin modes), a data register (which turns the IO port on or off), a multi-driving register (to control voltage levels?) and a fell pull registers (for pull-down and pull-up purposes).</p>
<p>For this project, only the configure register <code>PD_CFG2</code> and the data register <code>PD_DAT</code> will be used. All the other registers can be set if so desired, but it is not needed.</p>
<h2 id="creating-code-to-handle-pin-modes">Creating code to handle pin modes</h2>
<h3 id="memory-structure">Memory structure</h3>
<p>In chapter 3.21.2.21 (page 387) of the <a href="https://linux-sunxi.org/images/b/b4/Allwinner_A64_User_Manual_V1.1.pdf">user manual</a>, the following information can be seen:</p>
<table>
<thead>
<tr>
<th>Offset: 0x74</th>
<th style="text-align:center">Register Name: PD_CFG2_REG</th>
</tr>
</thead>
</table>
<table>
<thead>
<tr>
<th>Bit</th>
<th style="text-align:left">R/W</th>
<th style="text-align:left">Default/Hex</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>&hellip;</td>
<td style="text-align:left">&hellip;</td>
<td style="text-align:left">&hellip;</td>
<td style="text-align:center">&hellip;</td>
</tr>
<tr>
<td>18:16</td>
<td style="text-align:left">R/W</td>
<td style="text-align:left">0x7</td>
<td style="text-align:center">PD20_SELECT<br>000: Input <br> 001: Output<br>&hellip;</td>
</tr>
<tr>
<td>15</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:center">/</td>
</tr>
<tr>
<td>14:12</td>
<td style="text-align:left">R/W</td>
<td style="text-align:left">0x7</td>
<td style="text-align:center">PD19_SELECT<br>000: Input <br> 001: Output<br>&hellip;</td>
</tr>
<tr>
<td>11</td>
<td style="text-align:left">/</td>
<td style="text-align:left">/</td>
<td style="text-align:center">/</td>
</tr>
<tr>
<td>10:8</td>
<td style="text-align:left">R/W</td>
<td style="text-align:left">0x7</td>
<td style="text-align:center">PD18_SELECT<br>000: Input <br> 001: Output<br>&hellip;</td>
</tr>
<tr>
<td>&hellip;</td>
<td style="text-align:left">&hellip;</td>
<td style="text-align:left">&hellip;</td>
<td style="text-align:center">&hellip;</td>
</tr>
</tbody>
</table>
<p>A 3 bit value controls pin modes in register <code>PD_CFG2_REG</code>. Let&rsquo;s set some pin modes using the C language</p>
<p>The C language has a datatype called <code>struct</code>, which can be used to &ldquo;convert&rdquo; the table into the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#66d9ef">uint32_t</span> PD_16    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span> PD_17    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span> PD_18    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span> PD_19    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span> PD_20    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span> PD_21    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span> PD_22    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span> PD_23    : <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">uint32_t</span> reserved : <span style="color:#ae81ff">1</span>;
} PD_CFG2_REG_t;
</code></pre></div><p>The <code>struct</code> will ensure that the right bits are set in memory, without having to set individual bits.</p>
<h3 id="memory-location">Memory location</h3>
<p>In the above table, an offset of <code>0x74</code> can be seen. The memory address of this MMIO register will be <code>PIO</code> (<code>0x01C20800</code>) + <code>0x74</code>. In code, this could look as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define PIO 0x01C20800
</span><span style="color:#75715e">#define PD_CFG2_REG_ADDRESS (PIO + 0x74)
</span></code></pre></div><h2 id="altering-the-memory">Altering the memory</h2>
<p>The code to alter a piece of memory looks a bit magical, but it works quite well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define MODE_OUTPUT   0x1
</span><span style="color:#75715e">#define MODE_DISABLED 0x7 </span><span style="color:#75715e">// default
</span><span style="color:#75715e"></span>
((<span style="color:#66d9ef">volatile</span> PD_CFG2_REG_t<span style="color:#f92672">*</span>)PD_CFG2_REG_ADDRESS)<span style="color:#f92672">-&gt;</span>PD18 <span style="color:#f92672">=</span> MODE_OUTPUT;
((<span style="color:#66d9ef">volatile</span> PD_CFG2_REG_t<span style="color:#f92672">*</span>)PD_CFG2_REG_ADDRESS)<span style="color:#f92672">-&gt;</span>PD19 <span style="color:#f92672">=</span> MODE_OUTPUT;
((<span style="color:#66d9ef">volatile</span> PD_CFG2_REG_t<span style="color:#f92672">*</span>)PD_CFG2_REG_ADDRESS)<span style="color:#f92672">-&gt;</span>PD20 <span style="color:#f92672">=</span> MODE_OUTPUT;
</code></pre></div><ul>
<li>The values <code>0x1</code> and <code>0x7</code> are copied from the user manual in hexadacimal form and set the right pin mode. The user manual includes many more pin modes, but those are not used here.</li>
<li>The <code>volatile</code> keyword tells C that it should trust the programmer and just set the bits, as requested. Not including <code>volatile</code> will result in unpredictable behaviour.</li>
<li>The <code>PD_CFG2_REG_t*</code> part is part of a cast. C is told that whatever resides at the memory location of <code>PD_CFG2_REG_ADDRESS</code> is of type <code>PD_CFG2_REG_t*</code>.</li>
<li>So, <code>((volatile PD_CFG2_REG_t*)PD_CFG2_REG_ADDRESS)</code> can be seen as a pointer to a struct. Using this method, C can directly alter memory without the need for a variable.</li>
</ul>
<h2 id="turning-the-io-pins-on-or-off">Turning the IO pins on or off</h2>
<p>The method that is used to set the pin modes will be used to turn the IO pins on or off as well. The required table is found in chapter 3.21.2.23 (page 388) of the <a href="https://linux-sunxi.org/images/b/b4/Allwinner_A64_User_Manual_V1.1.pdf">user manual</a> and the <code>struct</code> and <code>address</code> will be as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#define PIO 0x01C20800                      </span><span style="color:#75715e">// same PIO address as the configure code uses
</span><span style="color:#75715e"></span><span style="color:#75715e">#define PD_DATA_REG_ADDRESS (PIO + 0x7C)    </span><span style="color:#75715e">// this time the offset is 0x7C
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#66d9ef">uint32_t</span>  PD_0      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_1      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_2      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_3      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_4      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_5      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_6      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_7      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_8      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_9      : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_10     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_11     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_12     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_13     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_14     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_15     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_16     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_17     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_18     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_19     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_20     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_21     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_22     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_23     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  PD_24     : <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">uint32_t</span>  reserved  : <span style="color:#ae81ff">7</span>;
} PD_DATA_REG_t;
</code></pre></div><p>And to then turn the IO pins on or off, very similar pointer-magic will be used:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">((<span style="color:#66d9ef">volatile</span> PD_DATA_REG_t<span style="color:#f92672">*</span>)PD_DATA_REG_ADDRESS)<span style="color:#f92672">-&gt;</span>PD18 <span style="color:#f92672">=</span> true; <span style="color:#75715e">// or false
</span><span style="color:#75715e"></span>((<span style="color:#66d9ef">volatile</span> PD_DATA_REG_t<span style="color:#f92672">*</span>)PD_DATA_REG_ADDRESS)<span style="color:#f92672">-&gt;</span>PD19 <span style="color:#f92672">=</span> true; <span style="color:#75715e">// or false
</span><span style="color:#75715e"></span>((<span style="color:#66d9ef">volatile</span> PD_DATA_REG_t<span style="color:#f92672">*</span>)PD_DATA_REG_ADDRESS)<span style="color:#f92672">-&gt;</span>PD20 <span style="color:#f92672">=</span> true; <span style="color:#75715e">// or false;
</span></code></pre></div><h1 id="creating-a-linux-kernel-module">Creating a linux kernel module</h1>
<h2 id="a-bare-bones-linux-kernel-module">A bare bones linux kernel module</h2>
<p>All the code that is required to set pinmodes is present, but if it&rsquo;s ran in userspace (even as superuser), it will result in a <code>segfault</code>. This is because the Linux kernel does not allow memory to be altered directly. To get around this, a kernel module will be written.</p>
<p>A bare bones kernel module looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// filename: mymodule.c (do not name it &#39;module.c&#39;!)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/module.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/kernel.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mymodule_init</span>(<span style="color:#66d9ef">void</span>) {
    <span style="color:#75715e">// do initializing here
</span><span style="color:#75715e"></span>    printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: Hello from kernel module!&#34;</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mymodule_exit</span>(<span style="color:#66d9ef">void</span>) {
    <span style="color:#75715e">// do exit stuff here
</span><span style="color:#75715e"></span>    printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: Goodbye from kernel module!&#34;</span>);
    <span style="color:#66d9ef">return</span>;
}

module_init(mymodule_init);
module_exit(mymodule_exit);
</code></pre></div><p>Make sure to not name anything <code>module</code>. Use a custom name like <code>mymodule</code>, or it might not compile.</p>
<p>The following <code>Makefile</code> will compile the kernel module:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile">obj-m <span style="color:#f92672">:=</span> mymodule.o

KERNEL_VERSION <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>shell uname -r<span style="color:#66d9ef">)</span>
KERNEL_DIR     <span style="color:#f92672">=</span> /usr/lib/modules/<span style="color:#66d9ef">$(</span>KERNEL_VERSION<span style="color:#66d9ef">)</span>/build/

<span style="color:#a6e22e">all</span><span style="color:#f92672">:</span>
	<span style="color:#75715e"># Create the kernel module</span>
	<span style="color:#66d9ef">$(</span>MAKE<span style="color:#66d9ef">)</span> -C <span style="color:#66d9ef">$(</span>KERNEL_DIR<span style="color:#66d9ef">)</span> M<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>PWD<span style="color:#66d9ef">)</span> modules
	<span style="color:#75715e"># Delete every other temporary file, leaving only the .ko file in place</span>
	<span style="color:#e6db74">`</span>rm mymodule.mo* mymodule.o modules.order Module.symvers ./.*.cmd<span style="color:#e6db74">`</span>

<span style="color:#a6e22e">clean</span><span style="color:#f92672">:</span>
	<span style="color:#75715e"># Delete all build files</span>
	<span style="color:#66d9ef">$(</span>MAKE<span style="color:#66d9ef">)</span> -C <span style="color:#66d9ef">$(</span>KERNEL_DIR<span style="color:#66d9ef">)</span> M<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>PWD<span style="color:#66d9ef">)</span> clean
</code></pre></div><p>To then add the kernel module to the kernel, the command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo insmod mymodule.ko
</code></pre></div><p>can be issued.</p>
<p>After that, when the command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo dmesg
</code></pre></div><p>can be executed to see the kernel logs. The new linux module should have logged a greeting. To see it happening in realtime, the <code>-w</code> option can de added to the dmesg command.</p>
<p>To remove the kernel module from the linux kernel, the command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo rmmod mymodule
</code></pre></div><p>can be used.</p>
<h2 id="a-kernel-module-that-alters-memory">A kernel module that alters memory</h2>
<p>To alter the MMIO registers of the PinePhone, a <code>character device</code> kernel module will be written. It will take an array of 3 characters and turn the right bits on and off using the values of the array. It will also be able to read the current state of the memory and return it in the form of a 3 character long array. All communication will happen through <code>/dev/mymodule</code>, a virtual device.</p>
<p>All the used memory locations and structures will be put in a separate file called <code>mmio.h</code>. The new kernel module looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/module.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/kernel.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/fs.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/cdev.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/semaphore.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/io.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/uaccess.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;mmio.h&#34;   // contains all the structs and addresses</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define DEVICE_NAME &#34;mymodule&#34;
</span><span style="color:#75715e">#define MAX_BUFFER_SIZE 3
</span><span style="color:#75715e"></span>
MODULE_DESCRIPTION(DEVICE_NAME);
MODULE_AUTHOR(<span style="color:#e6db74">&#34;Tom Niesse&#34;</span>);
MODULE_LICENSE(<span style="color:#e6db74">&#34;GPLv3&#34;</span>);

<span style="color:#75715e">// Create variables that have to do with registering a cdev object
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> cdev<span style="color:#f92672">*</span> mcdev;
<span style="color:#66d9ef">int</span> major_number;
<span style="color:#66d9ef">int</span> return_value;
dev_t dev_num;

<span style="color:#75715e">// Create a structure for a virtual device
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> virtual_device {
	<span style="color:#66d9ef">char</span> data[MAX_BUFFER_SIZE];
	<span style="color:#66d9ef">struct</span> semaphore sem;
} virtual_device;

<span style="color:#75715e">// Create file operations structure using define because it&#39;s position
</span><span style="color:#75715e">// in the module is a bit un-intuitive (in-between functions)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define FILE_OPERATIONS_CALLBACKS \
</span><span style="color:#75715e">struct file_operations fops = {\
</span><span style="color:#75715e">    .owner = THIS_MODULE,\
</span><span style="color:#75715e">    .open = device_open,\
</span><span style="color:#75715e">    .release = device_close,\
</span><span style="color:#75715e">    .write = device_write,\
</span><span style="color:#75715e">    .read = device_read\
</span><span style="color:#75715e">};
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Create variables that have to do with MMIO
</span><span style="color:#75715e"></span><span style="color:#66d9ef">volatile</span> PD_CFG2_REG_t<span style="color:#f92672">*</span> pd_cfg2_virtual_address <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">volatile</span> PD_DATA_REG_t<span style="color:#f92672">*</span> pd_data_virtual_address <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

<span style="color:#75715e">// A user wants to read to or write from /dev/mymodule
</span><span style="color:#75715e">// and opens the file
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">device_open</span>(<span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span> inode, <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>filp) {
	<span style="color:#66d9ef">if</span>(down_interruptible(<span style="color:#f92672">&amp;</span>virtual_device.sem) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
		printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: could not lock device for reading or writing.&#34;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
	}
	printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: device </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/dev/%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> is opened for reading or writing&#34;</span>, DEVICE_NAME);
	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#75715e">// A user is reading from /dev/mymodule
</span><span style="color:#75715e"></span>ssize_t <span style="color:#a6e22e">device_read</span>(<span style="color:#66d9ef">struct</span> file<span style="color:#f92672">*</span> filp, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buffer, size_t buffer_size, loff_t<span style="color:#f92672">*</span> current_offset) {
	printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: A user is reading from </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/dev/%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, writing information...&#34;</span>, DEVICE_NAME);

	<span style="color:#75715e">// Convert the booleans to characters for all colors (red and green switched)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD19_DATA) {
		virtual_device.data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
	} <span style="color:#66d9ef">else</span> {
		virtual_device.data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
	}

	<span style="color:#66d9ef">if</span>(pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD18_DATA) {
            virtual_device.data[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
    } <span style="color:#66d9ef">else</span> {
            virtual_device.data[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
    }

    <span style="color:#66d9ef">if</span>(pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD20_DATA) {
            virtual_device.data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;1&#39;</span>;
    } <span style="color:#66d9ef">else</span> {
            virtual_device.data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0&#39;</span>;
    }

	return_value <span style="color:#f92672">=</span> copy_to_user(buffer, virtual_device.data, buffer_size);
	<span style="color:#66d9ef">return</span> return_value;
}

<span style="color:#75715e">// A user is writing to /dev/mymodule
</span><span style="color:#75715e"></span>ssize_t <span style="color:#a6e22e">device_write</span>(<span style="color:#66d9ef">struct</span> file<span style="color:#f92672">*</span> filp, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buffer, size_t buffer_size, loff_t<span style="color:#f92672">*</span> current_offset) {
	<span style="color:#66d9ef">int</span> pos;

	<span style="color:#75715e">// Make sure the buffer is exactly 3 in length
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(buffer_size <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
	}

	printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: A user is writing to </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/dev/%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, reading information...&#34;</span>, DEVICE_NAME);
	return_value <span style="color:#f92672">=</span> copy_from_user(virtual_device.data, buffer, buffer_size);

	<span style="color:#75715e">// Set color red
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(virtual_device.data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span>) {
        pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD19_DATA <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    } <span style="color:#66d9ef">else</span> {
        pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD19_DATA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

	<span style="color:#75715e">// Set color green
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(virtual_device.data[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span>) {
        pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD18_DATA <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    } <span style="color:#66d9ef">else</span> {
        pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD18_DATA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

	<span style="color:#75715e">// Set color blue
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(virtual_device.data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;1&#39;</span>) {
        pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD20_DATA <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    } <span style="color:#66d9ef">else</span> {
        pd_data_virtual_address<span style="color:#f92672">-&gt;</span>PD20_DATA <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }

    <span style="color:#75715e">// Log for debugging purposes
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span>(pos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; pos <span style="color:#f92672">&lt;</span> MAX_BUFFER_SIZE; pos<span style="color:#f92672">++</span>) {
        printk(KERN_INFO <span style="color:#e6db74">&#34;Setting POS = %d to value %c&#34;</span>, pos, virtual_device.data[pos]);
	}
	<span style="color:#66d9ef">return</span> return_value;
}

<span style="color:#75715e">// A user is done with /dev/mymodule,
</span><span style="color:#75715e">// the file can be closed
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">device_close</span>(<span style="color:#66d9ef">struct</span> inode<span style="color:#f92672">*</span> inode, <span style="color:#66d9ef">struct</span> file<span style="color:#f92672">*</span> filp) {
	up(<span style="color:#f92672">&amp;</span>virtual_device.sem);
	printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: closed device </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/dev/%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">.&#34;</span>, DEVICE_NAME);
	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#75715e">// Place file operations callback structure here
</span><span style="color:#75715e"></span>FILE_OPERATIONS_CALLBACKS

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mymodule_init</span>(<span style="color:#66d9ef">void</span>) {
	<span style="color:#75715e">// Ask for virtual addresses to control MMIO
</span><span style="color:#75715e"></span>	pd_cfg2_virtual_address <span style="color:#f92672">=</span> ioremap((<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)PD_CFG2_REG_ADDRESS, <span style="color:#66d9ef">sizeof</span>(PD_CFG2_REG_t));
	pd_data_virtual_address <span style="color:#f92672">=</span> ioremap((<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)PD_DATA_REG_ADDRESS, <span style="color:#66d9ef">sizeof</span>(PD_DATA_REG_t));

	<span style="color:#75715e">// Register the /dev/mymodule connection
</span><span style="color:#75715e"></span>	return_value <span style="color:#f92672">=</span> alloc_chrdev_region(<span style="color:#f92672">&amp;</span>dev_num, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, DEVICE_NAME);
	<span style="color:#66d9ef">if</span>(return_value <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
		printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: failed to allocate a major number. virtual device will NOT work!&#34;</span>);
		<span style="color:#66d9ef">return</span> return_value;
	}

	major_number <span style="color:#f92672">=</span> MAJOR(dev_num);
	printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: major number is %d&#34;</span>, major_number);
	printk(KERN_INFO <span style="color:#e6db74">&#34;use </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">mknod /dev/%s c %d 0</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> to create a virtual device for this module.&#34;</span>, DEVICE_NAME, major_number);

	mcdev <span style="color:#f92672">=</span> cdev_alloc();
	mcdev<span style="color:#f92672">-&gt;</span>ops <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>fops;
	mcdev<span style="color:#f92672">-&gt;</span>owner <span style="color:#f92672">=</span> THIS_MODULE;

	return_value <span style="color:#f92672">=</span> cdev_add(mcdev, dev_num, <span style="color:#ae81ff">1</span>);
	<span style="color:#66d9ef">if</span>(return_value <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
		printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: could not add cdev to kernel. virtual device will NOT work!&#34;</span>);
		<span style="color:#66d9ef">return</span> return_value;
	}

	sema_init(<span style="color:#f92672">&amp;</span>virtual_device.sem, <span style="color:#ae81ff">1</span>);

	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mymodule_exit</span>(<span style="color:#66d9ef">void</span>) {
	<span style="color:#75715e">// Free the MMIO virtual addresses
</span><span style="color:#75715e"></span>	iounmap((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pd_cfg2_virtual_address);
	iounmap((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)pd_data_virtual_address);

	<span style="color:#75715e">// Unregister the module
</span><span style="color:#75715e"></span>	cdev_del(mcdev);
	unregister_chrdev_region(dev_num, <span style="color:#ae81ff">1</span>);

	printk(KERN_INFO <span style="color:#e6db74">&#34;mymodule: module has exited. make sure to delete </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">/dev/%s</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>, DEVICE_NAME);
}

module_init(mymodule_init);
module_exit(mymodule_exit);
</code></pre></div><p>When this module is loaded in using</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo insmod mymodule.ko
</code></pre></div><p>it will log how to make a virtual device. After executing that command as superuser, a virtual device called <code>/dev/mymodule</code> will have been created.</p>
<h1 id="communicating-with-the-kernel-module">Communicating with the kernel module</h1>
<p>Communication can be done using a C or C++ program that runs in userland (as superuser):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// main.c
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;fcntl.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define MAX_BUFFER_SIZE 3
</span><span style="color:#75715e">#define DEVICE          &#34;/dev/mymodule&#34;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">char</span> buffer[MAX_BUFFER_SIZE];

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// Perform a read operation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(DEVICE, O_RDWR);
    read(fd, this<span style="color:#f92672">-&gt;</span>buffer, MAX_BUFFER_SIZE);
    close(fd);

    <span style="color:#75715e">// Perform a write operation
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> open(DEVICE, O_RDWR);
    write(fd, this<span style="color:#f92672">-&gt;</span>buffer, MAX_BUFFER_SIZE);
    close(fd);

    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h1 id="controlling-other-peripherals">Controlling other peripherals</h1>
<p>The built-in motor, which makes the phone vibrate when a message arrives, is also directly controlled by a MMIO register of the A64 SoC. Another kernel module can be written to enable, disable and control that motor.</p>
]]></content>
        </item>
        
    </channel>
</rss>
